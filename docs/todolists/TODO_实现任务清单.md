# NPC生命线与叙事管理系统 - 实现任务清单

本文档根据《NPC生命线与叙事管理系统设计方案》制定，用于跟踪项目开发进度。

## Phase 1：核心框架（3-4个月）

### 1.1 Agent基础数据结构
- [ ] 设计Agent数据模型
  - [ ] 身份属性（角色定位、故事标签）
  - [ ] 状态属性（身体、心理、社交、经济状态）
  - [ ] 性格属性（勇气、忠诚、独立性、攻击性、谨慎性）
  - [ ] 能力属性（战斗技能、社交技能、专业技能、知识储备）
  - [ ] 记忆系统（轻量级事件记录）
- [ ] 实现Agent数据持久化
- [ ] 实现Agent数据序列化/反序列化

### 1.2 简单状态系统
- [ ] 实现身体状态系统
  - [ ] 健康值（0-100）
  - [ ] 伤势列表（轻伤、重伤、致残性伤害）
  - [ ] 体力/耐力
  - [ ] 战斗能力计算（受伤势影响）
- [ ] 实现心理状态系统
  - [ ] 士气（影响战斗表现）
  - [ ] 压力水平（影响决策理性度）
  - [ ] 对玩家的忠诚度
  - [ ] 信任度
- [ ] 实现社交状态系统
  - [ ] 声望
  - [ ] 与其他Agent的关系网络
  - [ ] 所属阵营及地位
- [ ] 实现经济状态系统
  - [ ] 财富
  - [ ] 债务
  - [ ] 拥有的资源和物品
- [ ] 实现状态更新机制
- [ ] 实现状态变化事件通知

### 1.3 基础决策系统
- [ ] 实现决策模式分层
  - [ ] 紧急模式（优先级最高，生命威胁时触发）
  - [ ] 战斗模式（处于战斗中）
  - [ ] 叙事模式（处于故事节点中）
  - [ ] 日常模式（无特殊情况）
- [ ] 实现if-else级别的简单决策逻辑
- [ ] 实现模式切换机制

### 1.4 时间推进系统
- [ ] 实现游戏时间系统
  - [ ] 昼夜循环
  - [ ] 季节变化
  - [ ] 时间加速/减速控制
- [ ] 实现时间对Agent行为的影响
- [ ] 实现时间事件触发机制

### 1.5 基础UI
- [ ] 实现Agent状态显示界面
  - [ ] 健康值显示
  - [ ] 状态属性显示
  - [ ] 关系网络可视化
- [ ] 实现关系变化提示
- [ ] 实现状态变化提示

## Phase 2：决策智能化（2-3个月）

### 2.1 目标系统
- [ ] 设计目标影响因素权重系统
  - [ ] Agent状态权重（0.3）
  - [ ] 叙事层任务权重（0.4）
  - [ ] 世界层政策制度权重（0.1）
  - [ ] 基本任务权重（0.2）
- [ ] 实现向量条件状态机方案
  - [ ] 目标向量计算
  - [ ] 权重矩阵设计
  - [ ] 可行性矩阵计算
- [ ] 实现简单神经网络方案（备选）
  - [ ] 输入层设计（状态特征、任务特征、政策特征、需求特征）
  - [ ] 隐藏层设计（2-3层，16-32神经元）
  - [ ] 输出层设计（目标得分）
  - [ ] 训练数据准备
- [ ] 实现目标优先级计算
- [ ] 实现目标缓存机制

### 2.2 条件回调机制
- [ ] 实现目标更新触发器
  - [ ] 状态变化超过阈值检测
  - [ ] 叙事任务变更检测
  - [ ] 政策法规变化检测
  - [ ] 基本需求变化检测
  - [ ] 当前目标完成/失败检测
- [ ] 实现回调注册机制
- [ ] 实现批量回调处理

### 2.3 行为执行系统
- [ ] 实现移动行为
  - [ ] 移动到指定地点
  - [ ] 路径跟随
  - [ ] 动态避障
- [ ] 实现交互行为
  - [ ] 移动到交互范围
  - [ ] 执行交互动作（对话、交易、战斗等）
  - [ ] 交互完成检测
- [ ] 实现工作行为
  - [ ] 移动到工作地点
  - [ ] 执行工作动作（重复性）
  - [ ] 工作完成检测
- [ ] 实现等待行为
  - [ ] 等待条件满足
  - [ ] 定期检查等待条件
- [ ] 实现行为中断机制
  - [ ] 紧急情况中断
  - [ ] 状态变化中断
  - [ ] 叙事触发中断
  - [ ] 玩家指令中断

### 2.4 路径规划与缓存系统
- [ ] 实现A*路径规划算法
- [ ] 实现路径缓存系统
  - [ ] 相同起点终点路径缓存
  - [ ] 缓存失效检测（地形变化、障碍物）
  - [ ] 缓存更新机制
- [ ] 实现分层路径规划
  - [ ] 粗粒度路径（区域到区域）
  - [ ] 细粒度路径（区域内精确路径）
- [ ] 实现动态避障（RVO算法或类似）

### 2.5 评分式决策系统
- [ ] 实现战斗决策评分机制
  - [ ] 进攻选项评分（威胁度、击败概率、风险等）
  - [ ] 支援选项评分（关系、重要性、危险程度等）
  - [ ] 防御/撤退选项评分（健康状况、战局、性格等）
- [ ] 实现性格调整机制
- [ ] 实现关系调整机制
- [ ] 实现随机性注入（10-20%）

### 2.6 战斗AI
- [ ] 实现战斗模式决策流程
  - [ ] 评估战场态势
  - [ ] 自我评估
  - [ ] 生成行动选项
  - [ ] 为选项评分
  - [ ] 性格和关系调整
  - [ ] 最终选择
- [ ] 实现战斗行为示例场景
  - [ ] 玩家被围攻场景
  - [ ] 伙伴受重伤场景
  - [ ] 战局劣势场景

### 2.7 性格影响系统
- [ ] 实现性格属性对决策的影响
  - [ ] 高攻击性 → 进攻选项得分+30%
  - [ ] 高谨慎性 → 防御选项得分+30%
  - [ ] 高忠诚性 → 支援选项得分+30%
  - [ ] 低勇气 → 撤退选项得分+50%
- [ ] 实现性格对目标选择的影响
- [ ] 实现性格对行为执行的影响

### 2.8 关系系统
- [ ] 实现Agent关系网络
  - [ ] 关系类型（好感、尊重、信任、依赖）
  - [ ] 关系强度（0-100）
  - [ ] 关系变化机制
- [ ] 实现关系对决策的影响
  - [ ] 高忠诚Agent支援玩家得分翻倍
  - [ ] 关系影响指令接受度
- [ ] 实现关系可视化

### 2.9 指挥系统
- [ ] 实现玩家指令系统
- [ ] 实现指令接受度计算
  - [ ] 基础意愿（合理/冒险/自杀性指令）
  - [ ] 关系调整
  - [ ] 性格调整
  - [ ] 状态调整
- [ ] 实现指令反馈机制
  - [ ] 完全执行
  - [ ] 质疑执行
  - [ ] 拒绝执行
  - [ ] 提出替代方案

### 2.10 商业行为系统
- [ ] 实现商品入市/退市决策
  - [ ] 商品基础价值评估
  - [ ] 市场供求关系分析
  - [ ] 资金状况检查
  - [ ] 周边Agent消费水平分析
  - [ ] 法律法规限制检查
- [ ] 实现价格设置公式
  - [ ] 基础价格计算（物品价值×品质系数）
  - [ ] 供求影响计算
  - [ ] 消费水平影响计算
  - [ ] 竞争影响计算
  - [ ] 最终价格计算（含上下限）
- [ ] 实现信誉系统
  - [ ] 价格调整频率追踪
  - [ ] 信誉变化计算
  - [ ] 信誉影响机制（交易意愿、价格稳定性）

## Phase 3：叙事系统（3-4个月）

### 3.1 节点图系统
- [ ] 设计故事节点数据结构
  - [ ] 剧情节点（Scene Node）
  - [ ] 选择节点（Decision Node）
  - [ ] 战斗节点（Battle Node）
  - [ ] 收束节点（Convergence Node）
  - [ ] 分支节点（Branch Node）
- [ ] 实现节点连接关系
- [ ] 实现节点条件检查
- [ ] 实现节点效果执行

### 3.2 故事推进逻辑
- [ ] 实现玩家驱动推进
  - [ ] 玩家完成目标检测
  - [ ] 玩家选择处理
- [ ] 实现Agent驱动推进
  - [ ] Agent完成目标检测
  - [ ] 多个Agent状态组合检测
- [ ] 实现时间驱动推进
  - [ ] 游戏时间到达检测
  - [ ] 自动触发机制
- [ ] 实现条件驱动推进
  - [ ] 世界状态条件检测
  - [ ] 条件满足触发

### 3.3 叙事任务分配
- [ ] 实现任务类型系统
  - [ ] 跟随任务
  - [ ] 到达任务
  - [ ] 交互任务
  - [ ] 等待任务
  - [ ] 执行任务
- [ ] 实现任务分配流程
  - [ ] 故事节点激活检测
  - [ ] 关联Agent识别
  - [ ] 任务分配
  - [ ] 任务输入到Agent目标系统
- [ ] 实现任务优先级机制
- [ ] 实现任务完成检测
  - [ ] 位置检测
  - [ ] 状态检测
  - [ ] 交互检测
  - [ ] 时间检测

### 3.4 收束点机制
- [ ] 实现收束点检测
- [ ] 实现状态归一化
  - [ ] 路径A状态处理
  - [ ] 路径B状态处理
  - [ ] 状态差异补偿
- [ ] 实现剧情调整
  - [ ] 根据路径调整对话
  - [ ] 根据路径调整事件
- [ ] 实现收束点设置原则检查

### 3.5 结局计算系统
- [ ] 实现结局影响因素收集
  - [ ] 关键决策点权重
  - [ ] Agent存活状态
  - [ ] 关系网状态
  - [ ] 世界状态
- [ ] 实现结局权重系统
  - [ ] 和平结局权重计算
  - [ ] 牺牲结局权重计算
  - [ ] 黑暗结局权重计算
- [ ] 实现最终结局确定
- [ ] 实现结局细节调整

### 3.6 故事进度管理
- [ ] 实现故事进度表
  - [ ] 当前章节追踪
  - [ ] 当前节点追踪
  - [ ] 活跃叙事Agent追踪
  - [ ] 待触发条件追踪
- [ ] 实现进度保存/加载

## Phase 4：世界系统（2-3个月）

### 4.1 自然世界-气候系统
- [ ] 实现气温系统
  - [ ] 基础气温（地理位置、季节）
  - [ ] 气温变化（天气影响）
  - [ ] 极端温度影响机制
- [ ] 实现气压系统
  - [ ] 基础气压（海拔、地理位置）
  - [ ] 气压变化（天气影响）
  - [ ] 低气压影响机制
- [ ] 实现天气现象系统
  - [ ] 天气类型（晴天、多云、雨天、雪天、暴风雨等）
  - [ ] 天气持续时间
  - [ ] 天气影响（战斗、经济、心理、健康）

### 4.2 自然世界-资源分布
- [ ] 实现资源类型系统
  - [ ] 矿产资源
  - [ ] 生物资源
  - [ ] 土地资源
  - [ ] 水资源
- [ ] 实现资源分布机制
  - [ ] 地理空间分布
  - [ ] 资源储量管理
  - [ ] 资源再生机制
- [ ] 实现资源开采系统
  - [ ] 开采行为
  - [ ] 资源消耗
  - [ ] 资源枯竭检测
- [ ] 实现资源影响机制
  - [ ] 影响Agent生产行为
  - [ ] 影响商业活动
  - [ ] 影响地区发展
  - [ ] 可能引发争夺

### 4.3 自然世界-自然事件
- [ ] 实现灾害性事件系统
  - [ ] 地震
  - [ ] 洪水
  - [ ] 干旱
  - [ ] 瘟疫
- [ ] 实现事件触发机制
- [ ] 实现事件影响机制
  - [ ] 影响Agent状态和行为
  - [ ] 可能触发特殊剧情
  - [ ] 可能影响自然资源分布

### 4.4 社会世界-法律法规系统
- [ ] 实现法律类型系统
  - [ ] 贸易法规
  - [ ] 治安法规
  - [ ] 社会规范
- [ ] 实现法律影响机制
  - [ ] 直接约束（惩罚机制）
  - [ ] 间接影响（市场环境）
- [ ] 实现法律变化系统
  - [ ] 剧情触发
  - [ ] 世界事件触发
  - [ ] 影响传播

### 4.5 社会世界-社会规则系统
- [ ] 实现社会规范系统
  - [ ] 不同地区/阵营规范
  - [ ] 违反规范影响（声望、关系）
- [ ] 实现等级制度系统
  - [ ] 社会地位
  - [ ] 权限和待遇
  - [ ] 等级变化机制

### 4.6 政府系统-政府Agent
- [ ] 实现政府作为独立Agent
  - [ ] 政府基础属性
  - [ ] 政府资源管理
  - [ ] 政府工作人员管理
- [ ] 实现政府与其他政府的关系系统

### 4.7 政府系统-收支系统
- [ ] 实现政府收入系统
  - [ ] 税收收入（个人所得税、商业税、财产税）
  - [ ] 资源开采税
  - [ ] 其他收入（罚款、关税等）
- [ ] 实现政府支出系统
  - [ ] 工作人员工资
  - [ ] 基础设施建设
  - [ ] 公共服务
  - [ ] 政府间关系维护
- [ ] 实现收支平衡机制
  - [ ] 收支计算
  - [ ] 财政盈余/赤字处理
  - [ ] 长期赤字后果

### 4.8 政府系统-货币发行
- [ ] 实现货币发行量控制
- [ ] 实现货币发行影响
  - [ ] 通货膨胀/紧缩
  - [ ] Agent财富实际价值
  - [ ] 市场价格水平
- [ ] 实现货币发行策略
  - [ ] 经济繁荣时策略
  - [ ] 经济衰退时策略
  - [ ] 财政赤字时策略

### 4.9 政府系统-税收系统
- [ ] 实现从Agent收入征收税收
  - [ ] 个人所得税计算
  - [ ] 商业税计算
  - [ ] 财产税计算
- [ ] 实现税收对Agent的影响
- [ ] 实现税收对政府收支的影响

### 4.10 政府系统-政策行为
- [ ] 实现政策法规变更
  - [ ] 触发条件检测（财政、社会、经济状况）
  - [ ] 政策方案制定
  - [ ] 新法规颁布
  - [ ] 影响传播
- [ ] 实现基础设施建设
  - [ ] 建设决策（财政、需求、战略）
  - [ ] 建设执行
  - [ ] 基础设施影响（交通、商业、就业）
- [ ] 实现政府间关系
  - [ ] 关系类型（友好/中立/敌对）
  - [ ] 关系影响（贸易、资源流动）
  - [ ] 关系维护（外交支出、协议、援助）

### 4.11 社会事件系统
- [ ] 实现政治事件
  - [ ] 政权更迭
  - [ ] 政策变化
  - [ ] 外交关系变化
- [ ] 实现社会动荡
  - [ ] 暴乱
  - [ ] 罢工
  - [ ] 抗议
- [ ] 实现事件触发机制
- [ ] 实现事件影响机制

## Phase 5：整合优化（持续）

### 5.1 系统整合
- [ ] 整合所有系统模块
- [ ] 确保三层架构交互正常
  - [ ] 叙事层 → Agent层
  - [ ] Agent层 → 世界层
  - [ ] 世界层 → Agent层
  - [ ] Agent层 → 叙事层
- [ ] 实现系统间数据同步
- [ ] 实现系统间事件通信

### 5.2 性能优化
- [ ] 实现目标系统优化
  - [ ] 条件回调更新
  - [ ] 并行计算（GPU/多线程）
  - [ ] 简化算法（远离玩家Agent）
  - [ ] 目标缓存
- [ ] 实现行为执行优化
  - [ ] 路径规划缓存
  - [ ] 分层路径规划
  - [ ] 批量更新
  - [ ] 空间分区
- [ ] 实现整体架构优化
  - [ ] 活跃区域Agent更新
  - [ ] 远离玩家Agent降频/休眠
  - [ ] 世界Agent简化决策
  - [ ] 叙事Agent完整决策
  - [ ] ECS架构实现

### 5.3 内容填充
- [ ] 创建故事内容
  - [ ] 主线故事
  - [ ] 支线故事
  - [ ] 伙伴个人剧情
- [ ] 创建Agent配置
  - [ ] 叙事Agent配置
  - [ ] 世界Agent配置
  - [ ] 政府Agent配置
- [ ] 创建世界规则配置
  - [ ] 自然世界规则
  - [ ] 社会世界规则
  - [ ] 法律法规配置

### 5.4 平衡调整
- [ ] 调整数值平衡
  - [ ] Agent状态数值
  - [ ] 决策权重
  - [ ] 价格计算公式参数
  - [ ] 税收税率
  - [ ] 政府收支参数
- [ ] 确保游戏体验合理
  - [ ] 不同策略可行性
  - [ ] 难度曲线
  - [ ] 玩家反馈响应

## 开发工具

### 故事编辑器
- [ ] 开发可视化节点图编辑器
  - [ ] 节点创建/编辑
  - [ ] 节点连接
  - [ ] 条件设置
  - [ ] 效果设置
  - [ ] 收束点配置

### Agent调试工具
- [ ] 开发实时查看Agent状态工具
- [ ] 开发查看Agent决策过程工具
- [ ] 开发Agent目标可视化工具
- [ ] 开发Agent关系网络可视化工具

### 数据分析工具
- [ ] 开发追踪玩家行为影响链工具
- [ ] 开发数据统计工具
  - [ ] 玩家选择分布
  - [ ] Agent死亡率
  - [ ] 结局达成率
  - [ ] 关系变化曲线
  - [ ] 商业行为统计
  - [ ] 世界状态统计
  - [ ] 政府系统状态统计

## 数据存储

- [ ] 选择数据存储方案
  - [ ] Agent数据（PostgreSQL或MongoDB）
  - [ ] 故事节点（Neo4j或JSON）
  - [ ] 世界状态（内存+持久化）
  - [ ] 自然资源分布（空间数据结构）
  - [ ] 政府数据（与Agent数据统一管理）
- [ ] 实现数据持久化
- [ ] 实现数据加载
- [ ] 实现数据备份/恢复

## 内容制作流程

### 故事设计
- [ ] 编写故事大纲
- [ ] 设计关键节点和分支
- [ ] 确定收束点位置
- [ ] 设计结局条件

### Agent设计
- [ ] 确定哪些是叙事Agent
- [ ] 设定初始状态和性格
- [ ] 设计与玩家的关系弧
- [ ] 编写专属剧情

### 节点制作
- [ ] 在编辑器中创建节点图
- [ ] 编写对话和描述
- [ ] 设置条件和效果
- [ ] 配置收束逻辑

### 测试与调整
- [ ] 跑通所有路径
- [ ] 测试Agent决策合理性
- [ ] 调整数值平衡
- [ ] 检查收束点是否自然

## 测试与平衡

### Agent行为测试
- [ ] 测试不同性格Agent的差异化表现
- [ ] 测试高忠诚Agent是否更愿意支援玩家
- [ ] 测试受伤Agent是否合理调整行为
- [ ] 测试目标系统是否正确响应状态变化
- [ ] 测试行为执行是否流畅
- [ ] 测试条件回调机制是否有效

### 叙事完整性测试
- [ ] 测试所有路径是否可达
- [ ] 测试收束点是否自然
- [ ] 测试结局是否合理
- [ ] 测试任务分配是否正常

### 影响传导测试
- [ ] 测试玩家行为是否产生预期影响
- [ ] 测试影响链是否合理
- [ ] 测试是否有意外的连锁反应
- [ ] 测试政府系统响应是否合理

### 平衡性测试
- [ ] 测试不同策略是否都可行
- [ ] 测试是否有最优解
- [ ] 测试难度曲线是否合理
- [ ] 测试数值平衡是否合理

### 性能测试
- [ ] 测试大量Agent时的性能
- [ ] 测试目标系统计算性能
- [ ] 测试路径规划性能
- [ ] 测试并行计算效果

## 文档与可视化

- [ ] 故事流程可视化
- [ ] Agent关系网可视化
- [ ] 影响传导可视化
- [ ] 数据统计可视化
- [ ] 系统架构文档
- [ ] API文档
- [ ] 用户手册

---

## 进度追踪

- **Phase 1**: 0/5 完成
- **Phase 2**: 0/10 完成
- **Phase 3**: 0/6 完成
- **Phase 4**: 0/11 完成
- **Phase 5**: 0/4 完成
- **开发工具**: 0/3 完成
- **数据存储**: 0/1 完成
- **内容制作**: 0/4 完成
- **测试**: 0/5 完成

**总计**: 0/49 主要模块完成

---

*最后更新: 2024年*

