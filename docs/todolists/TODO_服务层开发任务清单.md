# 服务层开发任务清单

本文档根据《服务层设计方案》制定，用于跟踪服务层开发进度。

> **参考信息**：
> - 设计方案：`docs/design/服务层设计方案.md`
> - API文档：https://docs.siliconflow.cn/cn/api-reference/chat-completions/chat-completions
> - 模型列表：https://cloud.siliconflow.cn/models
> - API Key获取：https://cloud.siliconflow.cn/account/ak

## Phase 1：基础设施层（Foundation Layer）

**状态**：✅ 已完成（最小实现 + 单测）\n\n- 详细任务与完成情况请见：`docs/todolists/service_layer/TODO_Phase1_基础设施层.md`

## Phase 2：API客户端层（API Client Layer）

**状态**：🚧 进行中（本阶段详细任务清单请见）\n\n- 详细任务清单：`docs/todolists/service_layer/TODO_Phase2_API客户端层.md`\n
### 2.1 SiliconFlow API客户端核心
- [ ] 实现API客户端基础框架
  - [ ] API Key管理
  - [ ] Base URL配置
  - [ ] 认证头设置
- [ ] 实现同步API调用
  - [ ] Chat Completions接口封装
  - [ ] 请求序列化（JSON）
  - [ ] 响应反序列化
- [ ] 实现异步API调用
- [ ] 实现流式响应处理
  - [ ] SSE格式解析
  - [ ] 流式数据块处理
  - [ ] 流式响应回调机制

### 2.2 API请求构建
- [ ] 实现请求参数构建
  - [ ] 模型选择
  - [ ] 消息列表构建
  - [ ] 温度、Top-p、Top-k参数
  - [ ] Max tokens设置
  - [ ] Stop sequences
- [ ] 实现Function Calling请求构建
  - [ ] 工具列表序列化
  - [ ] Tool choice设置
- [ ] 实现多模态请求构建（图像输入）

### 2.3 API响应解析
- [ ] 实现标准响应解析
  - [ ] 内容提取
  - [ ] Token使用统计
  - [ ] Finish reason解析
- [ ] 实现Function Calling响应解析
  - [ ] 工具调用提取
  - [ ] 参数解析
- [ ] 实现错误响应解析

## Phase 3：核心管理层（Core Management Layer）

### 3.1 模型管理器（ModelManager）
- [ ] 实现模型配置加载
  - [ ] 从配置文件加载模型列表
  - [ ] 模型能力映射（任务类型支持）
  - [ ] 模型参数配置（上下文长度、温度等）
- [ ] 实现模型注册和管理
  - [ ] 模型添加/移除
  - [ ] 模型查询
  - [ ] 模型健康状态监控
- [ ] 实现模型性能统计
  - [ ] 请求计数
  - [ ] 响应时间统计
  - [ ] 成功率统计
  - [ ] 负载因子计算
- [ ] 实现按任务类型查询模型

### 3.2 任务路由器（TaskRouter）
- [ ] 实现路由表初始化
  - [ ] 任务类型到模型的映射
  - [ ] 模型优先级排序
- [ ] 实现智能路由算法
  - [ ] 任务类型匹配
  - [ ] 上下文容量检查
  - [ ] 模型评分计算
  - [ ] 负载均衡考虑
  - [ ] 成本优化考虑
- [ ] 实现路由决策记录和日志

### 3.3 上下文管理器（ContextManager）
- [ ] 实现对话历史管理
  - [ ] 历史消息存储
  - [ ] 历史消息查询
  - [ ] 历史消息裁剪
- [ ] 实现上下文构建器
  - [ ] System Prompt构建
  - [ ] Agent状态上下文构建
  - [ ] 项目上下文构建
  - [ ] 代码上下文构建
  - [ ] 记忆事件上下文构建
- [ ] 实现上下文窗口管理
  - [ ] Token限制检查
  - [ ] 智能上下文裁剪
  - [ ] 消息重要性评分
- [ ] 实现上下文配置管理

## Phase 4：服务管理层（Service Management Layer）

### 4.1 请求管理器（RequestManager）
- [ ] 实现请求队列
  - [ ] 优先级队列实现
  - [ ] 请求入队/出队
  - [ ] 队列大小限制
- [ ] 实现并发控制器
  - [ ] 按模型限制并发数
  - [ ] 并发请求计数
  - [ ] 并发限制检查
- [ ] 实现请求调度器
  - [ ] 队列处理循环
  - [ ] 请求分发
  - [ ] 超时管理
- [ ] 实现请求取消机制
- [ ] 实现请求统计

### 4.2 响应处理器（ResponseHandler）
- [ ] 实现流式响应处理
  - [ ] SSE数据流解析
  - [ ] 增量内容提取
  - [ ] 流式回调管理
- [ ] 实现响应验证
  - [ ] JSON格式验证
  - [ ] 必需字段检查
- [ ] 实现响应缓存集成
- [ ] 实现响应统计

### 4.3 缓存管理器（CacheManager）
- [ ] 实现缓存键生成
  - [ ] 基于请求内容的哈希
  - [ ] 模型ID、温度等参数包含
- [ ] 实现缓存存储
  - [ ] 内存缓存实现
  - [ ] 缓存条目结构
  - [ ] TTL管理
- [ ] 实现缓存查询
- [ ] 实现缓存过期清理
- [ ] 实现缓存统计（命中率等）

## Phase 5：工具调用层（Tool Calling Layer）

### 5.1 工具管理器（ToolManager）
- [ ] 实现工具注册机制
  - [ ] 工具定义结构
  - [ ] 工具处理器注册
  - [ ] 工具参数Schema定义
- [ ] 实现工具查询
  - [ ] 按名称查询
  - [ ] 列出所有工具
- [ ] 实现工具执行
  - [ ] 参数验证
  - [ ] 工具调用
  - [ ] 结果返回
  - [ ] 错误处理
- [ ] 实现工具权限控制（可选）

### 5.2 代码工具集（CodeTools）
- [ ] 实现read_file工具
  - [ ] 文件读取
  - [ ] 行范围支持
  - [ ] 错误处理
- [ ] 实现list_files工具
  - [ ] 目录遍历
  - [ ] 文件过滤
  - [ ] 递归选项
- [ ] 实现search_code工具
  - [ ] 文本搜索
  - [ ] 正则表达式支持
  - [ ] 文件类型过滤
- [ ] 实现get_project_structure工具
  - [ ] 项目结构分析
  - [ ] CMake解析
  - [ ] 依赖关系提取
- [ ] 实现analyze_code工具
  - [ ] 代码解析
  - [ ] 函数/类提取
  - [ ] 依赖分析

### 5.3 Function Calling处理器
- [ ] 实现工具调用检测
  - [ ] 响应中工具调用识别
  - [ ] 工具调用参数提取
- [ ] 实现工具调用执行流程
  - [ ] 批量工具调用
  - [ ] 结果收集
- [ ] 实现后续请求构建
  - [ ] 工具结果消息构建
  - [ ] 多轮对话支持

### 5.4 MCP服务（MCPService）
- [ ] 实现MCP协议基础
  - [ ] JSON-RPC消息格式
  - [ ] 消息序列化/反序列化
- [ ] 实现MCP Server
  - [ ] 工具列表接口
  - [ ] 工具调用接口
  - [ ] 错误处理
- [ ] 实现MCP工具注册
  - [ ] 从ToolManager转换
  - [ ] MCP工具格式适配
- [ ] 实现MCP与LLM集成
  - [ ] MCP工具转Function Calling格式
  - [ ] 工具调用结果处理

### 5.5 项目上下文收集器（ProjectContextCollector）
- [ ] 实现项目结构分析
  - [ ] 目录扫描
  - [ ] 文件类型识别
  - [ ] CMakeLists.txt解析
- [ ] 实现依赖关系提取
- [ ] 实现文件上下文收集
  - [ ] 相关文件查找
  - [ ] 上下文范围确定
- [ ] 实现项目摘要生成

## Phase 6：多模态服务层（Multimodal Service Layer）

### 6.1 语音服务（SpeechService）
- [ ] 实现STT（语音转文本）
  - [ ] 音频数据预处理
  - [ ] API调用封装
  - [ ] 结果解析
  - [ ] 置信度处理
- [ ] 实现流式STT
  - [ ] 实时音频流处理
  - [ ] 增量文本输出
- [ ] 实现TTS（文本转语音）
  - [ ] 文本预处理
  - [ ] 音色选择
  - [ ] 语速/音调参数
  - [ ] 音频数据返回
- [ ] 实现流式TTS
- [ ] 实现语音活动检测（VAD）
  - [ ] 音频分析
  - [ ] 语音检测算法

### 6.2 视觉服务（VisionService）
- [ ] 实现屏幕采集
  - [ ] 屏幕截图API封装
  - [ ] 图像数据格式转换
  - [ ] 分辨率控制
- [ ] 实现屏幕信息提取
  - [ ] 窗口标题获取
  - [ ] 活动应用识别
  - [ ] OCR文本提取（可选）
- [ ] 实现VLM快速场景分析
  - [ ] 快速VLM模型调用
  - [ ] 场景类型判断
  - [ ] 响应需求判断
- [ ] 实现VLM详细场景分析
  - [ ] 详细VLM模型调用
  - [ ] 场景描述生成
  - [ ] 关键词提取

### 6.3 对话触发器（ConversationTrigger）
- [ ] 实现输入响应判断
  - [ ] 关键词检查
  - [ ] VLM场景分析集成
  - [ ] 文本内容分析
- [ ] 实现主动对话触发
  - [ ] 规则引擎
  - [ ] 条件检查
  - [ ] 响应生成建议
- [ ] 实现优先级计算
- [ ] 实现触发规则注册机制

### 6.4 屏幕采集调度器（ScreenCaptureScheduler）
- [ ] 实现采集模式管理
  - [ ] 低频模式
  - [ ] 高频模式
  - [ ] 按需模式
- [ ] 实现采集循环
  - [ ] 定时采集
  - [ ] 采集回调
- [ ] 实现模式切换
- [ ] 实现采集历史管理

## Phase 7：服务层主接口（Main Service Interface）

### 7.1 AIService主类实现
- [ ] 实现服务初始化
  - [ ] 各组件初始化
  - [ ] 配置加载
  - [ ] 依赖注入
- [ ] 实现通用请求接口
  - [ ] 同步处理接口
  - [ ] 异步处理接口
  - [ ] 流式处理接口
- [ ] 实现便捷方法
  - [ ] chat方法
  - [ ] generateCode方法
  - [ ] analyzeCode方法
  - [ ] assistDecision方法
  - [ ] chatWithTools方法
- [ ] 实现多模态对话接口
  - [ ] 完整STT-VLM-LLM-TTS流程
  - [ ] 智能响应判断集成

### 7.2 服务层集成
- [ ] 整合所有组件
  - [ ] 组件间通信
  - [ ] 数据流管理
- [ ] 实现统一错误处理
- [ ] 实现统一日志系统
- [ ] 实现服务生命周期管理

## Phase 8：测试与优化（Testing & Optimization）

### 8.1 单元测试
- [ ] HTTP客户端测试
- [ ] API客户端测试
- [ ] 模型管理器测试
- [ ] 任务路由器测试
- [ ] 上下文管理器测试
- [ ] 请求管理器测试
- [ ] 工具管理器测试
- [ ] Function Calling测试
- [ ] 语音服务测试
- [ ] 视觉服务测试

### 8.2 集成测试
- [ ] 端到端API调用测试
- [ ] 工具调用流程测试
- [ ] MCP服务测试
- [ ] 多模态流程测试
- [ ] 错误处理和重试测试
- [ ] 并发请求测试
- [ ] 缓存机制测试

### 8.3 性能优化
- [ ] 请求队列优化
- [ ] 并发控制优化
- [ ] 缓存策略优化
- [ ] 上下文裁剪优化
- [ ] 连接池优化
- [ ] 内存使用优化

### 8.4 监控与日志
- [ ] 实现请求统计
- [ ] 实现性能指标收集
- [ ] 实现日志系统
- [ ] 实现错误追踪

## Phase 9：文档与部署（Documentation & Deployment）

### 9.1 API文档
- [ ] 编写服务层API文档
- [ ] 编写使用示例
- [ ] 编写配置说明
- [ ] 编写错误码说明

### 9.2 开发文档
- [ ] 编写架构说明
- [ ] 编写扩展指南
- [ ] 编写最佳实践

### 9.3 部署准备
- [ ] 配置文件模板
- [ ] 环境变量说明
- [ ] 依赖项清单
- [ ] 构建说明

---

## 进度追踪

- **Phase 1 - 基础设施层**: ✅ 已完成（详见 Phase1 分文档）
- **Phase 2 - API客户端层**: 0/3 完成（详见 Phase2 分文档）
- **Phase 3 - 核心管理层**: 0/3 完成
- **Phase 4 - 服务管理层**: 0/3 完成
- **Phase 5 - 工具调用层**: 0/5 完成
- **Phase 6 - 多模态服务层**: 0/4 完成
- **Phase 7 - 服务层主接口**: 0/2 完成
- **Phase 8 - 测试与优化**: 0/4 完成
- **Phase 9 - 文档与部署**: 0/3 完成

**总计**: 1/32 主要模块完成（Phase1 已完成）

---

## 开发优先级建议

### 高优先级（核心功能）
1. Phase 1: 基础设施层（必须首先完成）
2. Phase 2: API客户端层（核心通信）
3. Phase 3: 核心管理层（智能路由和上下文）
4. Phase 4: 服务管理层（请求和响应处理）
5. Phase 7: 服务层主接口（统一入口）

### 中优先级（增强功能）
6. Phase 5: 工具调用层（代码开发辅助）
7. Phase 8: 测试与优化（质量保证）

### 低优先级（扩展功能）
8. Phase 6: 多模态服务层（语音和视觉，可后续添加）
9. Phase 9: 文档与部署（持续完善）

---

*最后更新: 2025年12月16日*

