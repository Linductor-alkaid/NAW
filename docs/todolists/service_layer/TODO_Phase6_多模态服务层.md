# Phase 6：多模态服务层（Multimodal Service Layer）详细任务清单

本文档是阶段六多模态服务层的详细开发任务清单，基于《服务层设计方案》制定，并以 Phase1、Phase2、Phase3、Phase4、Phase5 已完成的基础设施层、API 客户端层、核心管理层、服务管理层和工具调用层为依赖。

> **参考信息**：
> - 设计方案：`docs/design/服务层设计方案.md`
> - Phase1 详细清单：`docs/todolists/service_layer/TODO_Phase1_基础设施层.md`
> - Phase2 详细清单：`docs/todolists/service_layer/TODO_Phase2_API客户端层.md`
> - Phase3 详细清单：`docs/todolists/service_layer/TODO_Phase3_核心管理层.md`
> - Phase4 详细清单：`docs/todolists/service_layer/TODO_Phase4_服务管理层.md`
> - Phase5 详细清单：`docs/todolists/service_layer/TODO_Phase5_工具调用层.md`
> - 总体任务清单：`docs/todolists/TODO_服务层开发任务清单.md`

## 概述

### 目标
- 实现 **语音服务（SpeechService）**：提供语音转文本（STT）、文本转语音（TTS）和语音活动检测（VAD）功能。
- 实现 **视觉服务（VisionService）**：提供屏幕采集、多层视觉处理（CV层、YOLO层、复杂CV层、VLM层）和屏幕信息提取功能。
- 实现 **智能调度引擎（SmartScheduler）**：基于硬件性能、实时负载、场景优先级和用户行为学习的四维调度决策系统。
- 实现 **对话触发器（ConversationTrigger）**：基于视觉分析和文本分析的智能对话触发机制。
- 实现 **屏幕采集调度器（ScreenCaptureScheduler）**：支持多模式（低频/高频/按需）的屏幕采集调度系统，包含游戏模式优化。

### 非目标（明确留到后续Phase）
- 服务层主接口整合（Phase7）。
- 情绪状态机和记忆系统（属于Agent层，不在服务层）。
- 桌宠表现层（UI层，不在服务层）。

### 依赖与关键组件（Phase6 前置）
- [x] Phase1 已提供：
  - `ConfigManager`：配置文件加载和环境变量支持。
  - `ErrorHandler`：统一错误处理。
- [x] Phase2 已提供：
  - `APIClient`：API调用能力，支持多模态请求（图像输入）。
- [x] Phase3 已提供：
  - `ModelManager`：模型配置和管理。
  - `TaskRouter`：任务路由和模型选择。
  - `ContextManager`：上下文构建和管理。
- [x] Phase4 已提供：
  - `RequestManager`：请求队列管理和并发控制。
  - `ResponseHandler`：响应处理。
  - `CacheManager`：缓存管理。
- [x] Phase5 已提供：
  - `ToolManager`：工具管理（可用于代码工具）。
  - `FunctionCallingHandler`：Function Calling处理。

### 视觉服务技术框架

Phase6 的视觉服务采用四层处理架构和智能调度引擎：

**四层处理架构**：
- **Layer 0: CV实时处理层**（100+ FPS）：帧差检测、色彩分析、运动检测
- **Layer 1: YOLO中频处理层**（1-10 FPS）：物体检测、场景分类
- **Layer 2: 复杂CV处理层**（按需触发）：模板匹配、特征点检测、轮廓分析
- **Layer 3: VLM深度理解层**（0.1-1次/分钟）：语义理解、上下文分析、意图识别

**智能调度引擎**：
- 硬件性能感知（GPU/CPU档位）
- 实时负载监控（占用率/温度）
- 场景优先级（游戏/办公/待机）
- 用户行为学习（时段模式）

**游戏模式优化**：
- 游戏自动检测
- ROI区域处理（仅关键区域）
- 帧跳跃采样（智能降频）
- 暂停YOLO/VLM（保证性能）

---

## 6.1 语音服务（SpeechService）

### 6.1.1 任务概述
实现语音转文本（STT）、文本转语音（TTS）和语音活动检测（VAD）功能，支持同步和流式处理。

### 6.1.2 文件结构（建议）
```
include/naw/desktop_pet/service/
└── SpeechService.h

src/naw/desktop_pet/service/
└── SpeechService.cpp
```

### 6.1.3 详细任务清单

#### 6.1.3.1 STT（语音转文本）基础功能
- [x] **音频数据预处理**
  - [x] 实现音频格式转换（支持 WAV、PCM、MP3 等）
  - [x] 实现音频重采样（统一采样率，如 16kHz）
  - [x] 实现音频归一化（音量标准化）
  - [x] 实现音频分片（长音频分段处理）
  - [x] 处理音频格式错误和无效数据

- [x] **API调用封装**
  - [x] 实现硅基流动或其他STT API调用接口
  - [x] 构建STT请求（音频数据、语言参数等）
  - [x] 处理API认证和错误重试
  - [x] 实现请求超时控制
  - [x] 集成 `RequestManager` 进行请求管理

- [x] **结果解析**
  - [x] 解析API返回的文本结果
  - [x] 提取时间戳信息（可选，如果有）
  - [x] 提取说话人信息（可选，如果支持）
  - [x] 处理空结果和错误结果

- [x] **置信度处理**
  - [x] 提取识别置信度分数
  - [x] 实现置信度阈值过滤（低置信度结果处理）
  - [x] 返回置信度信息（供上层决策使用）

**验收标准**：
- 单测验证：音频预处理正确（格式转换、重采样、归一化）。
- 单测验证：API调用成功，结果解析正确。
- 单测验证：置信度处理正确。

#### 6.1.3.2 流式STT实现
- [x] **实时音频流处理**
  - [x] 实现音频流缓冲区管理
  - [x] 实现音频流分块处理（固定时长分块，如 1秒）
  - [x] 实现音频流拼接和缓存
  - [x] 处理音频流中断和恢复

- [x] **增量文本输出**
  - [x] 实现增量结果回调机制
  - [x] 处理部分识别结果（临时文本）
  - [x] 实现最终结果确认（完整句子识别）
  - [x] 处理句子边界检测
  - [x] 返回流式结果（通过回调函数）

**验收标准**：
- 单测验证：音频流处理正确（分块、拼接）。
- 单测验证：增量文本输出正确（临时结果、最终结果）。

#### 6.1.3.3 TTS（文本转语音）基础功能
- [x] **文本预处理**
  - [x] 实现文本清理（去除特殊字符、标准化）
  - [x] 实现文本分段（长文本分段合成）
  - [x] 处理SSML标记（如果API支持）
  - [x] 处理文本编码（UTF-8等）

- [x] **音色选择**
  - [x] 实现音色列表获取（从API或配置）
  - [x] 实现音色参数设置
  - [x] 支持音色切换
  - [x] 音色参数验证

- [x] **语速/音调参数**
  - [x] 实现语速设置（speed参数）
  - [x] 实现音调设置（pitch参数）
  - [x] 实现音量设置（volume参数）
  - [x] 参数范围验证

- [x] **音频数据返回**
  - [x] 解析API返回的音频数据（Base64解码等）
  - [x] 转换为标准音频格式（WAV、MP3等）
  - [x] 返回音频数据（字节流或文件路径）
  - [x] 处理音频合成失败

**验收标准**：
- 单测验证：文本预处理正确。
- 单测验证：音色、语速、音调参数正确设置。
- 单测验证：音频数据返回正确（格式、内容）。

#### 6.1.3.4 流式TTS实现
- [x] **流式音频合成**
  - [x] 实现流式TTS API调用（如果支持）
  - [x] 处理流式音频数据块
  - [x] 实现音频数据块拼接
  - [x] 返回流式音频数据（通过回调函数）

**验收标准**：
- 单测验证：流式TTS正确处理（数据块、拼接）。

#### 6.1.3.5 语音活动检测（VAD）
- [x] **音频分析**
  - [x] 实现音频能量计算（RMS、短时能量）
  - [x] 实现频谱分析（FFT、频谱特征）
  - [x] 实现零交叉率计算（ZCR）
  - [x] 实现音频特征提取（MFCC等，可选）

- [x] **语音检测算法**
  - [x] 实现能量阈值检测（基于短时能量）
  - [x] 实现频谱特征检测（基于频谱特征）
  - [x] 实现多特征融合检测（能量+频谱+ZCR）
  - [x] 实现语音段标记（开始/结束时间）
  - [x] 处理噪声和静音段
  - [x] 实现检测参数可配置（阈值、窗口大小等）

**验收标准**：
- 单测验证：语音活动检测正确（准确率、误检率）。
- 单测验证：检测参数可配置。

---

## 6.2 视觉服务（VisionService）

### 6.2.1 任务概述
实现屏幕采集、多层视觉处理（CV层、YOLO层、复杂CV层、VLM层）和屏幕信息提取功能，支持高性能实时处理。

### 6.2.2 文件结构（建议）
```
include/naw/desktop_pet/service/
├── VisionService.h
├── ScreenCapture.h
├── VisionLayer0.h        (CV实时处理层)
├── VisionLayer1.h        (YOLO中频处理层)
├── VisionLayer2.h        (复杂CV处理层)
├── VisionLayer3.h        (VLM深度理解层)
└── SmartScheduler.h      (智能调度引擎)

src/naw/desktop_pet/service/
├── VisionService.cpp
├── ScreenCapture.cpp
├── VisionLayer0.cpp
├── VisionLayer1.cpp
├── VisionLayer2.cpp
├── VisionLayer3.cpp
└── SmartScheduler.cpp
```

### 6.2.3 详细任务清单

#### 6.2.3.1 屏幕采集模块（ScreenCapture）
- [ ] **屏幕截图API封装**
  - [ ] 实现跨平台屏幕截图（Windows、Linux、macOS）
    - [ ] Windows: 使用 `BitBlt`、`PrintWindow` 或 DXGI
    - [ ] Linux: 使用 `X11` 或 `Wayland`
    - [ ] macOS: 使用 `CoreGraphics`
  - [ ] 实现全屏截图
  - [ ] 实现指定窗口截图
  - [ ] 实现指定区域截图（ROI）
  - [ ] 处理截图权限问题

- [ ] **图像数据格式转换**
  - [ ] 实现图像格式转换（BMP、PNG、JPEG、RGB数组等）
  - [ ] 实现颜色空间转换（RGB、BGR、RGBA、灰度等）
  - [ ] 实现图像压缩（JPEG质量、PNG压缩等）
  - [ ] 优化转换性能（使用GPU加速，可选）

- [ ] **分辨率控制**
  - [ ] 实现图像缩放（降采样、上采样）
  - [ ] 实现分辨率配置（最大分辨率、目标分辨率）
  - [ ] 实现自适应分辨率（根据处理层需求调整）
  - [ ] 保持宽高比或裁剪

- [ ] **截图性能优化**
  - [ ] 实现截图缓存（避免重复截图）
  - [ ] 实现增量截图（仅捕获变化区域，可选）
  - [ ] 实现多线程截图（并行处理，可选）
  - [ ] 性能统计（截图耗时、FPS等）

**验收标准**：
- 单测验证：屏幕截图成功（全屏、窗口、区域）。
- 单测验证：图像格式转换正确。
- 单测验证：分辨率控制正确。
- 性能测试：截图FPS满足需求（>10 FPS）。

#### 6.2.3.2 Layer 0: CV实时处理层（VisionLayer0）
- [ ] **帧差检测**
  - [ ] 实现帧差计算（当前帧与前一帧差值）
  - [ ] 实现二值化（阈值化处理）
  - [ ] 实现噪声去除（形态学操作）
  - [ ] 计算变化区域（连通域分析）
  - [ ] 计算变化程度指标（变化像素比例）
  - [ ] 性能优化（GPU加速，可选）

- [ ] **色彩分析**
  - [ ] 实现直方图计算（RGB、HSV直方图）
  - [ ] 实现主色调提取（K-means聚类，可选）
  - [ ] 实现色彩分布统计
  - [ ] 计算色彩变化指标（直方图差异）
  - [ ] 性能优化（快速算法、采样计算）

- [ ] **运动检测**
  - [ ] 实现光流计算（Lucas-Kanade或Farneback，可选）
  - [ ] 实现运动区域检测
  - [ ] 计算运动强度和方向
  - [ ] 性能优化（稀疏光流、降低分辨率）

- [ ] **变化阈值判断**
  - [ ] 实现综合变化评分（帧差+色彩+运动）
  - [ ] 实现阈值配置（可配置阈值参数）
  - [ ] 判断是否需要触发下一层（Layer 1）
  - [ ] 实现阈值自适应（根据场景动态调整）

**验收标准**：
- 单测验证：帧差检测正确（变化区域识别）。
- 单测验证：色彩分析正确（直方图、主色调）。
- 单测验证：运动检测正确（运动区域、强度）。
- 性能测试：处理FPS > 100（降低分辨率情况下）。

#### 6.2.3.3 Layer 1: YOLO中频处理层（VisionLayer1）
- [ ] **YOLO模型集成**
  - [ ] 集成YOLO推理库（YOLOv8、YOLOv5等，使用ONNX Runtime或TensorRT）
  - [ ] 实现模型加载和初始化
  - [ ] 实现模型配置（模型路径、置信度阈值等）
  - [ ] 实现GPU/CPU推理选择
  - [ ] 性能优化（批量推理、TensorRT优化等）

- [ ] **物体检测**
  - [ ] 实现物体检测推理（输入图像，输出检测框）
  - [ ] 解析检测结果（类别、置信度、边界框）
  - [ ] 实现物体过滤（按类别、置信度过滤）
  - [ ] 实现NMS（非极大值抑制）
  - [ ] 返回检测结果（物体列表）

- [ ] **场景分类**
  - [ ] 实现场景分类模型集成（或基于物体检测结果分类）
  - [ ] 定义场景类别（编程、游戏、浏览、办公、待机等）
  - [ ] 实现场景分类推理
  - [ ] 计算场景置信度
  - [ ] 返回场景类别和置信度

- [ ] **复杂场景判断**
  - [ ] 实现场景复杂度评估（物体数量、场景类型等）
  - [ ] 判断是否需要触发Layer 2（复杂CV处理）
  - [ ] 判断是否需要触发Layer 3（VLM深度理解）
  - [ ] 场景优先级计算（用于调度决策）

**验收标准**：
- 单测验证：物体检测正确（检测框、类别、置信度）。
- 单测验证：场景分类正确（场景类别、置信度）。
- 性能测试：处理FPS 1-10（根据模型和硬件）。

#### 6.2.3.4 Layer 2: 复杂CV处理层（VisionLayer2）
- [ ] **模板匹配**
  - [ ] 实现模板匹配算法（OpenCV `matchTemplate`）
  - [ ] 支持多模板匹配
  - [ ] 支持多尺度模板匹配
  - [ ] 返回匹配位置和置信度

- [ ] **特征点检测**
  - [ ] 实现特征点检测（SIFT、SURF、ORB、AKAZE等）
  - [ ] 实现特征描述子提取
  - [ ] 实现特征匹配（BFMatcher、FLANN等）
  - [ ] 返回特征点和匹配结果

- [ ] **轮廓分析**
  - [ ] 实现轮廓检测（`findContours`）
  - [ ] 实现轮廓特征提取（面积、周长、形状等）
  - [ ] 实现轮廓筛选（按面积、形状等）
  - [ ] 实现轮廓匹配（形状匹配）
  - [ ] 返回轮廓分析结果

- [ ] **按需触发机制**
  - [ ] 实现触发条件判断（来自Layer 1的复杂场景判断）
  - [ ] 实现处理区域选择（ROI区域处理）
  - [ ] 实现结果融合（多种方法结果融合）
  - [ ] 判断是否需要触发Layer 3

**验收标准**：
- 单测验证：模板匹配正确（位置、置信度）。
- 单测验证：特征点检测和匹配正确。
- 单测验证：轮廓分析正确（特征提取、匹配）。

#### 6.2.3.5 Layer 3: VLM深度理解层（VisionLayer3）
- [ ] **VLM模型调用**
  - [ ] 实现VLM API调用（使用硅基流动或其他VLM API）
  - [ ] 构建VLM请求（图像+提示词）
  - [ ] 处理VLM响应解析
  - [ ] 集成 `APIClient` 和 `RequestManager`
  - [ ] 实现请求缓存（相同图像+提示词缓存结果）

- [ ] **语义理解**
  - [ ] 实现场景描述生成（"用户在编程IDE中编写代码"）
  - [ ] 实现关键信息提取（窗口标题、应用名称、主要内容等）
  - [ ] 实现意图识别（用户意图推测）
  - [ ] 返回语义理解结果（JSON格式）

- [ ] **上下文分析**
  - [ ] 实现多帧上下文分析（结合历史帧信息）
  - [ ] 实现场景变化分析（场景转换检测）
  - [ ] 实现用户行为模式识别（工作流识别）
  - [ ] 返回上下文分析结果

- [ ] **意图识别**
  - [ ] 实现意图分类（是否需要响应、响应优先级等）
  - [ ] 实现响应需求判断（是否需要桌宠响应）
  - [ ] 实现意图置信度计算
  - [ ] 返回意图识别结果

- [ ] **频率控制**
  - [ ] 实现请求频率限制（0.1-1次/分钟）
  - [ ] 实现请求队列管理（限制并发VLM请求数）
  - [ ] 实现优先级调度（高优先级场景优先处理）
  - [ ] 实现请求取消机制（场景变化时取消待处理请求）
  - [ ] 性能统计（请求耗时、成功率等）

**验收标准**：
- 单测验证：VLM模型调用成功，响应解析正确。
- 单测验证：语义理解正确（场景描述、关键信息、意图）。
- 单测验证：上下文分析正确（多帧分析、场景变化、行为模式）。
- 单测验证：频率控制正确（请求频率限制）。
- 性能测试：处理频率满足需求（0.1-1次/分钟）。

#### 6.2.3.6 屏幕信息提取（ScreenInfoExtractor）
- [ ] **窗口标题获取**
  - [ ] 实现跨平台窗口标题获取（Windows、Linux、macOS）
  - [ ] 实现活动窗口检测
  - [ ] 实现窗口层级查询
  - [ ] 处理权限问题

- [ ] **活动应用识别**
  - [ ] 实现应用进程识别（通过窗口句柄或进程ID）
  - [ ] 实现应用名称提取
  - [ ] 实现应用类型分类（IDE、浏览器、游戏、办公等）
  - [ ] 实现应用状态检测（前台/后台、最小化等）

- [ ] **OCR文本提取（可选）**
  - [ ] 集成OCR库（Tesseract、EasyOCR等）
  - [ ] 实现图像预处理（二值化、去噪等）
  - [ ] 实现文本识别和提取
  - [ ] 实现文本区域定位（可选，精确提取特定区域）
  - [ ] 性能优化（选择性OCR，仅在需要时调用）

**验收标准**：
- 单测验证：窗口标题获取正确。
- 单测验证：活动应用识别正确。
- 单测验证：OCR文本提取正确（如果实现）。

---

## 6.3 智能调度引擎（SmartScheduler）

### 6.3.1 任务概述
实现基于硬件性能、实时负载、场景优先级和用户行为学习的四维调度决策系统，智能调度多层视觉处理任务的执行。

### 6.3.2 文件结构（建议）
```
include/naw/desktop_pet/service/
└── SmartScheduler.h

src/naw/desktop_pet/service/
└── SmartScheduler.cpp
```

### 6.3.3 详细任务清单

#### 6.3.3.1 硬件性能感知
- [ ] **GPU性能检测**
  - [ ] 实现GPU信息查询（GPU型号、显存、算力等）
  - [ ] 实现GPU性能档位评估（高性能/中性能/低性能）
  - [ ] 支持多GPU系统（主GPU选择）
  - [ ] 跨平台支持（CUDA、OpenCL、Vulkan等）

- [ ] **CPU性能检测**
  - [ ] 实现CPU信息查询（CPU型号、核心数、频率等）
  - [ ] 实现CPU性能档位评估（高性能/中性能/低性能）
  - [ ] 实现CPU能力评分（综合评分）

- [ ] **性能档位配置**
  - [ ] 定义性能档位（High/Medium/Low）
  - [ ] 实现档位到处理能力的映射（Layer 0/1/2/3的可用性）
  - [ ] 实现性能档位自动检测
  - [ ] 支持手动配置性能档位（覆盖自动检测）

**验收标准**：
- 单测验证：GPU/CPU信息查询正确。
- 单测验证：性能档位评估正确。
- 单测验证：档位到处理能力映射正确。

#### 6.3.3.2 实时负载监控
- [ ] **GPU负载监控**
  - [ ] 实现GPU使用率查询（占用率、显存使用率）
  - [ ] 实现GPU温度监控
  - [ ] 实现GPU频率监控（当前频率、最大频率）
  - [ ] 实现GPU负载阈值设置（高负载/中负载/低负载）

- [ ] **CPU负载监控**
  - [ ] 实现CPU使用率查询（整体使用率、核心使用率）
  - [ ] 实现CPU温度监控（如果支持）
  - [ ] 实现CPU频率监控
  - [ ] 实现CPU负载阈值设置

- [ ] **系统资源监控**
  - [ ] 实现内存使用率监控
  - [ ] 实现系统负载监控（整体系统负载）
  - [ ] 实现资源使用趋势分析（负载变化趋势）

- [ ] **负载自适应调度**
  - [ ] 实现负载感知的调度策略（高负载时降低处理频率）
  - [ ] 实现动态调整处理层（根据负载启用/禁用Layer 1/2/3）
  - [ ] 实现负载恢复机制（负载降低时恢复处理）

**验收标准**：
- 单测验证：GPU/CPU负载监控正确（使用率、温度、频率）。
- 单测验证：负载自适应调度正确（负载高时降低处理）。

#### 6.3.3.3 场景优先级管理
- [ ] **场景优先级定义**
  - [ ] 定义场景优先级等级（Critical/High/Normal/Low）
  - [ ] 定义场景类型到优先级的映射（游戏=Critical、编程=High、浏览=Normal、待机=Low）
  - [ ] 实现优先级配置（可配置场景优先级）

- [ ] **场景优先级计算**
  - [ ] 实现场景优先级评估（基于场景类型、用户行为等）
  - [ ] 实现动态优先级调整（场景变化时重新计算）
  - [ ] 实现优先级队列（高优先级场景优先处理）

- [ ] **场景切换检测**
  - [ ] 实现场景变化检测（从Layer 1的场景分类结果）
  - [ ] 实现场景切换通知（通知调度器场景变化）
  - [ ] 实现场景历史记录（场景变化历史）

**验收标准**：
- 单测验证：场景优先级计算正确。
- 单测验证：场景切换检测正确。
- 单测验证：优先级队列调度正确。

#### 6.3.3.4 用户行为学习
- [ ] **时段模式学习**
  - [ ] 实现用户行为数据收集（时段、场景类型等）
  - [ ] 实现时段模式分析（工作时间、休息时间等）
  - [ ] 实现模式识别（识别用户的典型行为模式）
  - [ ] 实现模式存储和加载（持久化用户行为模式）

- [ ] **行为预测**
  - [ ] 实现基于时段的场景预测（预测用户在不同时段的典型场景）
  - [ ] 实现基于历史的场景预测（基于最近场景预测下一个场景）
  - [ ] 实现预测置信度计算

- [ ] **自适应调度**
  - [ ] 实现基于预测的预处理调度（预测场景到来前提前准备）
  - [ ] 实现预测错误的处理（预测不准确时的回退机制）
  - [ ] 实现学习率控制（避免过度依赖历史数据）

**验收标准**：
- 单测验证：时段模式学习正确（数据收集、模式识别）。
- 单测验证：行为预测正确（场景预测、置信度）。
- 单测验证：自适应调度正确（基于预测的调度）。

#### 6.3.3.5 调度决策引擎
- [ ] **四维决策融合**
  - [ ] 实现四维因子融合算法（硬件性能、实时负载、场景优先级、用户行为）
  - [ ] 实现权重配置（各因子的权重可配置）
  - [ ] 实现综合评分计算（综合评分决定是否启用各处理层）
  - [ ] 实现决策结果输出（处理层启用/禁用决策）

- [ ] **调度策略实现**
  - [ ] 实现Layer 0调度策略（始终启用，但频率可调整）
  - [ ] 实现Layer 1调度策略（根据决策启用/禁用，频率1-10 FPS）
  - [ ] 实现Layer 2调度策略（按需触发，仅在复杂场景时启用）
  - [ ] 实现Layer 3调度策略（严格频率限制，0.1-1次/分钟）

- [ ] **调度优化**
  - [ ] 实现调度决策缓存（相同条件下复用决策）
  - [ ] 实现调度决策历史记录（用于分析和优化）
  - [ ] 实现调度性能统计（调度效果评估）

**验收标准**：
- 单测验证：四维决策融合正确（综合评分、决策结果）。
- 单测验证：调度策略正确（各层启用/禁用、频率控制）。
- 性能测试：调度决策响应时间满足需求（<10ms）。

---

## 6.4 屏幕采集调度器（ScreenCaptureScheduler）

### 6.4.1 任务概述
实现支持多模式（低频/高频/按需）的屏幕采集调度系统，包含游戏模式优化，管理屏幕采集的触发和频率。

### 6.4.2 文件结构（建议）
```
include/naw/desktop_pet/service/
└── ScreenCaptureScheduler.h

src/naw/desktop_pet/service/
└── ScreenCaptureScheduler.cpp
```

### 6.4.3 详细任务清单

#### 6.4.3.1 采集模式管理
- [ ] **低频模式**
  - [ ] 实现低频模式配置（采集频率，如 1 FPS）
  - [ ] 实现低频模式触发条件（待机场景、低优先级场景）
  - [ ] 实现低频模式下的处理层限制（仅启用Layer 0，可选Layer 1）
  - [ ] 实现模式切换（从其他模式切换到低频模式）

- [ ] **高频模式**
  - [ ] 实现高频模式配置（采集频率，如 10-30 FPS）
  - [ ] 实现高频模式触发条件（高优先级场景、需要实时响应）
  - [ ] 实现高频模式下的处理层配置（启用Layer 0和Layer 1）
  - [ ] 实现模式切换（从其他模式切换到高频模式）

- [ ] **按需模式**
  - [ ] 实现按需模式配置（手动触发或事件触发）
  - [ ] 实现按需模式触发接口（`captureOnDemand()`）
  - [ ] 实现按需模式下的完整处理（所有处理层可用）
  - [ ] 实现按需模式优先级（按需请求优先处理）

- [ ] **模式自动切换**
  - [ ] 实现基于场景的模式切换（场景变化时自动切换模式）
  - [ ] 实现基于负载的模式切换（负载高时自动降频）
  - [ ] 实现模式切换平滑过渡（避免频繁切换）

**验收标准**：
- 单测验证：各模式配置和触发正确。
- 单测验证：模式切换正确（自动切换、平滑过渡）。

#### 6.4.3.2 采集循环实现
- [ ] **定时采集**
  - [ ] 实现定时器管理（基于配置频率的定时采集）
  - [ ] 实现采集任务队列（采集任务入队、出队）
  - [ ] 实现采集线程管理（独立线程执行采集）
  - [ ] 处理采集超时（采集任务超时处理）

- [ ] **采集回调**
  - [ ] 实现采集完成回调（采集成功后通知上层）
  - [ ] 实现采集失败回调（采集失败时通知上层）
  - [ ] 实现采集结果传递（图像数据传递给处理层）
  - [ ] 支持多个回调函数注册

- [ ] **采集同步**
  - [ ] 实现采集任务同步（避免并发采集冲突）
  - [ ] 实现采集结果缓存（最新采集结果缓存）
  - [ ] 实现采集结果订阅（多个订阅者订阅采集结果）

**验收标准**：
- 单测验证：定时采集正确（频率控制、任务队列）。
- 单测验证：采集回调正确（成功/失败回调）。
- 单测验证：采集同步正确（避免冲突、结果缓存）。

#### 6.4.3.3 游戏模式优化
- [ ] **游戏检测**
  - [ ] 实现游戏应用识别（通过应用名称、窗口标题、进程特征等）
  - [ ] 实现游戏场景检测（通过Layer 1的场景分类结果）
  - [ ] 实现游戏模式自动切换（检测到游戏时自动切换到游戏模式）
  - [ ] 支持游戏列表配置（可配置游戏应用列表）

- [ ] **ROI区域处理**
  - [ ] 实现ROI区域定义（仅处理屏幕关键区域）
  - [ ] 实现ROI区域提取（从全屏图像中提取ROI区域）
  - [ ] 实现ROI区域智能选择（基于游戏类型选择关键区域）
  - [ ] 性能优化（处理区域减小，性能提升）

- [ ] **帧跳跃采样**
  - [ ] 实现帧跳跃采样（每隔N帧处理一次，降低处理频率）
  - [ ] 实现智能降频（根据游戏帧率动态调整采样率）
  - [ ] 实现采样策略配置（可配置跳跃帧数）

- [ ] **性能保护**
  - [ ] 实现Layer 1暂停（游戏模式下暂停YOLO处理）
  - [ ] 实现Layer 3暂停（游戏模式下暂停VLM处理）
  - [ ] 实现Layer 0保持（保持基础CV处理，用于变化检测）
  - [ ] 实现性能监控（监控游戏帧率，确保不影响游戏性能）

**验收标准**：
- 单测验证：游戏检测正确（游戏识别、自动切换）。
- 单测验证：ROI区域处理正确（区域提取、性能优化）。
- 单测验证：帧跳跃采样正确（降频、采样策略）。
- 性能测试：游戏模式下CPU/GPU占用率降低（不影响游戏性能）。

#### 6.4.3.4 采集历史管理
- [ ] **历史记录**
  - [ ] 实现采集历史存储（时间戳、图像、处理结果等）
  - [ ] 实现历史记录容量限制（最大存储数量、时间窗口）
  - [ ] 实现历史记录查询（按时间、按场景等查询）
  - [ ] 实现历史记录清理（自动清理过期记录）

- [ ] **历史分析**
  - [ ] 实现场景变化历史分析（场景变化趋势）
  - [ ] 实现用户行为历史分析（行为模式分析）
  - [ ] 实现性能历史分析（处理性能趋势）
  - [ ] 返回历史分析结果（用于调度优化）

**验收标准**：
- 单测验证：历史记录正确（存储、查询、清理）。
- 单测验证：历史分析正确（场景变化、行为模式、性能趋势）。

---

## 6.5 对话触发器（ConversationTrigger）

### 6.5.1 任务概述
实现基于视觉分析和文本分析的智能对话触发机制，判断何时需要桌宠主动响应或响应用户输入。

### 6.5.2 文件结构（建议）
```
include/naw/desktop_pet/service/
└── ConversationTrigger.h

src/naw/desktop_pet/service/
└── ConversationTrigger.cpp
```

### 6.5.3 详细任务清单

#### 6.5.3.1 输入响应判断
- [ ] **关键词检查**
  - [ ] 实现关键词列表配置（可配置触发关键词）
  - [ ] 实现关键词匹配算法（精确匹配、模糊匹配）
  - [ ] 实现关键词上下文检查（关键词前后的上下文判断）
  - [ ] 实现关键词优先级（不同关键词的优先级）
  - [ ] 返回匹配结果（匹配的关键词、位置、置信度）

- [ ] **VLM场景分析集成**
  - [ ] 集成Layer 3的VLM深度理解结果
  - [ ] 实现场景意图解析（从VLM结果中提取意图）
  - [ ] 实现响应需求判断（基于VLM的意图识别结果）
  - [ ] 实现场景变化触发（场景变化时触发对话）
  - [ ] 实现异常场景检测（异常场景时触发对话）

- [ ] **文本内容分析**
  - [ ] 实现文本提取（从OCR、剪贴板、输入法等获取文本）
  - [ ] 实现文本意图分析（使用LLM进行意图分析，可选）
  - [ ] 实现文本情感分析（判断用户情感状态，可选）
  - [ ] 实现文本关键词提取（提取文本中的关键信息）
  - [ ] 返回文本分析结果（意图、情感、关键词等）

**验收标准**：
- 单测验证：关键词检查正确（匹配、上下文、优先级）。
- 单测验证：VLM场景分析集成正确（意图解析、响应需求判断）。
- 单测验证：文本内容分析正确（意图、情感、关键词）。

#### 6.5.3.2 主动对话触发
- [ ] **规则引擎**
  - [ ] 实现触发规则定义结构（规则条件、规则动作等）
  - [ ] 实现规则匹配引擎（规则条件评估）
  - [ ] 实现规则优先级（多个规则同时匹配时的优先级）
  - [ ] 实现规则动态加载（支持运行时添加/删除规则）
  - [ ] 实现规则日志记录（规则匹配和执行日志）

- [ ] **条件检查**
  - [ ] 实现时间条件检查（时段条件，如工作时间、休息时间）
  - [ ] 实现场景条件检查（场景类型条件，如编程场景、游戏场景）
  - [ ] 实现行为条件检查（用户行为条件，如长时间未操作）
  - [ ] 实现复合条件检查（多条件组合：AND、OR、NOT）
  - [ ] 实现条件阈值配置（可配置条件阈值）

- [ ] **响应生成建议**
  - [ ] 实现响应内容建议（基于场景和规则的响应内容）
  - [ ] 实现响应类型建议（主动问候、提醒、建议等）
  - [ ] 实现响应时机建议（何时触发响应最合适）
  - [ ] 实现响应优先级建议（响应的重要程度）
  - [ ] 返回响应建议结果（供上层决策使用）

**验收标准**：
- 单测验证：规则引擎正确（规则匹配、优先级、动态加载）。
- 单测验证：条件检查正确（时间、场景、行为、复合条件）。
- 单测验证：响应生成建议正确（内容、类型、时机、优先级）。

#### 6.5.3.3 优先级计算
- [ ] **优先级评估算法**
  - [ ] 实现优先级评分系统（综合多个因子计算优先级）
  - [ ] 实现优先级因子定义（关键词匹配度、场景重要性、用户状态等）
  - [ ] 实现优先级权重配置（各因子的权重可配置）
  - [ ] 实现优先级评分计算（综合评分决定触发优先级）
  - [ ] 返回优先级评分结果（0-100评分或优先级等级）

- [ ] **多触发器优先级处理**
  - [ ] 实现多个触发器同时触发时的优先级处理
  - [ ] 实现优先级队列（高优先级触发优先处理）
  - [ ] 实现优先级冲突解决（相同优先级时的处理策略）
  - [ ] 实现优先级降级机制（长时间未响应时降低优先级）

- [ ] **动态优先级调整**
  - [ ] 实现基于时间的优先级调整（优先级随时间衰减）
  - [ ] 实现基于用户反馈的优先级调整（用户忽略后降低优先级）
  - [ ] 实现优先级历史记录（优先级变化历史）

**验收标准**：
- 单测验证：优先级评估算法正确（评分计算、权重配置）。
- 单测验证：多触发器优先级处理正确（优先级队列、冲突解决）。
- 单测验证：动态优先级调整正确（时间衰减、用户反馈）。

#### 6.5.3.4 触发规则注册机制
- [ ] **规则注册接口**
  - [ ] 实现规则注册方法（`registerRule(const TriggerRule& rule)`）
  - [ ] 实现规则移除方法（`unregisterRule(const std::string& ruleId)`）
  - [ ] 实现规则更新方法（`updateRule(const std::string& ruleId, const TriggerRule& rule)`）
  - [ ] 实现规则查询方法（`getRule(const std::string& ruleId)`、`getAllRules()`）
  - [ ] 线程安全（使用 mutex 保护规则注册表）

- [ ] **规则定义结构**
  - [ ] 定义 `TriggerRule` 结构体
    - [ ] `ruleId`（规则ID，唯一标识）
    - [ ] `ruleName`（规则名称）
    - [ ] `conditions`（触发条件列表）
    - [ ] `priority`（规则优先级）
    - [ ] `actions`（触发动作列表）
    - [ ] `enabled`（是否启用）
    - [ ] `metadata`（元数据，如创建时间、更新时间等）
  - [ ] 定义 `TriggerCondition` 结构体（条件定义）
  - [ ] 定义 `TriggerAction` 结构体（动作定义）

- [ ] **规则持久化**
  - [ ] 实现规则保存到配置文件（JSON格式）
  - [ ] 实现规则从配置文件加载
  - [ ] 实现规则自动保存（规则变更时自动保存）
  - [ ] 实现规则导入/导出（支持规则备份和恢复）

- [ ] **规则验证**
  - [ ] 实现规则有效性验证（条件、动作格式验证）
  - [ ] 实现规则冲突检测（检测规则之间的冲突）
  - [ ] 实现规则依赖检查（检查规则依赖的条件是否存在）
  - [ ] 返回验证结果（成功/失败 + 错误信息）

**验收标准**：
- 单测验证：规则注册接口正确（注册、移除、更新、查询）。
- 单测验证：规则定义结构正确（条件、动作定义）。
- 单测验证：规则持久化正确（保存、加载、导入/导出）。
- 单测验证：规则验证正确（有效性、冲突检测、依赖检查）。

---

## 6.6 单元测试与示例

### 6.6.1 单元测试
- [x] **SpeechService测试**
  - [x] STT基础功能测试（音频预处理、API调用、结果解析、置信度处理）
  - [x] 流式STT测试（音频流处理、增量文本输出）
  - [x] TTS基础功能测试（文本预处理、音色选择、语速/音调、音频数据返回）
  - [x] 流式TTS测试（流式音频合成）
  - [x] VAD测试（音频分析、语音检测算法）

- [ ] **VisionService测试**
  - [ ] ScreenCapture测试（屏幕截图、格式转换、分辨率控制、性能优化）
  - [ ] VisionLayer0测试（帧差检测、色彩分析、运动检测、变化阈值判断）
  - [ ] VisionLayer1测试（YOLO模型集成、物体检测、场景分类、复杂场景判断）
  - [ ] VisionLayer2测试（模板匹配、特征点检测、轮廓分析、按需触发）
  - [ ] VisionLayer3测试（VLM模型调用、语义理解、上下文分析、意图识别、频率控制）
  - [ ] ScreenInfoExtractor测试（窗口标题获取、活动应用识别、OCR文本提取）

- [ ] **SmartScheduler测试**
  - [ ] 硬件性能感知测试（GPU/CPU性能检测、性能档位评估）
  - [ ] 实时负载监控测试（GPU/CPU负载监控、负载自适应调度）
  - [ ] 场景优先级管理测试（场景优先级计算、场景切换检测）
  - [ ] 用户行为学习测试（时段模式学习、行为预测、自适应调度）
  - [ ] 调度决策引擎测试（四维决策融合、调度策略、调度优化）

- [ ] **ScreenCaptureScheduler测试**
  - [ ] 采集模式管理测试（低频/高频/按需模式、模式切换）
  - [ ] 采集循环测试（定时采集、采集回调、采集同步）
  - [ ] 游戏模式优化测试（游戏检测、ROI区域处理、帧跳跃采样、性能保护）
  - [ ] 采集历史管理测试（历史记录、历史分析）

- [ ] **ConversationTrigger测试**
  - [ ] 输入响应判断测试（关键词检查、VLM场景分析集成、文本内容分析）
  - [ ] 主动对话触发测试（规则引擎、条件检查、响应生成建议）
  - [ ] 优先级计算测试（优先级评估算法、多触发器优先级处理、动态优先级调整）
  - [ ] 触发规则注册机制测试（规则注册接口、规则定义结构、规则持久化、规则验证）

### 6.6.2 集成测试
- [ ] **VisionService + SmartScheduler 集成测试**
  - [ ] 完整的四层处理流程（Layer 0 -> Layer 1 -> Layer 2 -> Layer 3）
  - [ ] 智能调度决策流程（调度器根据四维因子决定处理层启用/禁用）
  - [ ] 场景切换时的调度调整（场景变化时调度器动态调整处理层）

- [ ] **ScreenCaptureScheduler + VisionService 集成测试**
  - [ ] 采集到处理的完整流程（屏幕采集 -> 各层处理 -> 结果输出）
  - [ ] 多模式下的处理流程（低频/高频/按需模式下的处理差异）
  - [ ] 游戏模式下的性能保护（游戏模式下确保不影响游戏性能）

- [ ] **VisionService + ConversationTrigger 集成测试**
  - [ ] 视觉分析触发对话流程（VLM分析结果 -> 对话触发器 -> 对话生成）
  - [ ] 场景变化触发对话流程（场景切换检测 -> 对话触发）
  - [ ] 多源信息融合触发（视觉+文本+关键词 -> 对话触发）

- [ ] **SpeechService + ConversationTrigger 集成测试**
  - [ ] 语音输入触发对话流程（STT -> 文本分析 -> 对话触发）
  - [ ] 语音活动检测触发流程（VAD -> 语音段检测 -> 对话触发）

- [ ] **完整多模态流程集成测试**
  - [ ] STT-VLM-LLM-TTS完整流程（语音输入 -> 视觉分析 -> LLM响应 -> 语音输出）
  - [ ] 多模态输入融合流程（视觉+语音+文本 -> 对话触发）
  - [ ] 端到端性能测试（完整流程的响应时间、资源占用）

- [ ] **系统集成测试**
  - [ ] 与Phase1-5组件的集成测试（ConfigManager、APIClient、ModelManager、RequestManager、ToolManager等）
  - [ ] 错误处理和重试测试（各服务模块的错误处理）
  - [ ] 并发处理测试（多个服务同时运行的并发安全性）
  - [ ] 资源管理测试（内存、GPU、CPU资源的管理和释放）

---

## 开发顺序建议

### 第一阶段：基础服务（6.1 和 6.2.3.1）
1. 先完成 `ScreenCapture` 模块，这是视觉服务的基础。
2. 实现 `SpeechService` 的基础功能（STT、TTS），为多模态对话提供支持。

### 第二阶段：视觉处理层（6.2.3.2-6.2.3.5）
1. 按顺序实现四层视觉处理：
   - Layer 0: CV实时处理层（最简单，性能要求高）
   - Layer 1: YOLO中频处理层（需要集成YOLO模型）
   - Layer 2: 复杂CV处理层（按需触发，可选）
   - Layer 3: VLM深度理解层（需要集成VLM API）
2. 实现屏幕信息提取（ScreenInfoExtractor）。

### 第三阶段：智能调度（6.3）
1. 完成智能调度引擎（SmartScheduler）。
2. 实现四维调度决策系统。
3. 集成到视觉处理层，实现智能调度。

### 第四阶段：采集调度器（6.4）
1. 完成屏幕采集调度器（ScreenCaptureScheduler）。
2. 实现多模式管理和游戏模式优化。
3. 集成到整个视觉处理流程。

### 第五阶段：对话触发（6.5）
1. 完成对话触发器（ConversationTrigger）。
2. 集成视觉服务和语音服务的结果。
3. 实现规则引擎和优先级计算。

### 第六阶段：集成和测试
1. 完成所有模块的集成测试。
2. 性能测试和优化。
3. 错误处理和边界情况测试。

---

## 进度追踪

### 6.1 语音服务（SpeechService）
- [ ] STT基础功能
- [ ] 流式STT
- [ ] TTS基础功能
- [ ] 流式TTS
- [ ] 语音活动检测（VAD）
- [ ] 单元测试

**进度**: 0/6 主要模块完成

### 6.2 视觉服务（VisionService）
- [ ] ScreenCapture模块（屏幕采集）
- [ ] VisionLayer0（CV实时处理层）
- [ ] VisionLayer1（YOLO中频处理层）
- [ ] VisionLayer2（复杂CV处理层）
- [ ] VisionLayer3（VLM深度理解层）
- [ ] ScreenInfoExtractor（屏幕信息提取）
- [ ] 单元测试

**进度**: 0/7 主要模块完成

### 6.3 智能调度引擎（SmartScheduler）
- [ ] 硬件性能感知
- [ ] 实时负载监控
- [ ] 场景优先级管理
- [ ] 用户行为学习
- [ ] 调度决策引擎
- [ ] 单元测试

**进度**: 0/6 主要模块完成

### 6.4 屏幕采集调度器（ScreenCaptureScheduler）
- [ ] 采集模式管理
- [ ] 采集循环实现
- [ ] 游戏模式优化
- [ ] 采集历史管理
- [ ] 单元测试

**进度**: 0/5 主要模块完成

### 6.5 对话触发器（ConversationTrigger）
- [ ] 输入响应判断
- [ ] 主动对话触发
- [ ] 优先级计算
- [ ] 触发规则注册机制
- [ ] 单元测试

**进度**: 0/5 主要模块完成

### 6.6 单元测试与示例
- [ ] SpeechService测试
- [ ] VisionService测试
- [ ] SmartScheduler测试
- [ ] ScreenCaptureScheduler测试
- [ ] ConversationTrigger测试
- [ ] 集成测试

**进度**: 0/6 主要模块完成

---

## 总体进度

**Phase 6 总体进度**: 0/35 主要模块完成

**各模块完成情况**：
- 6.1 语音服务（SpeechService）: 0/6
- 6.2 视觉服务（VisionService）: 0/7
- 6.3 智能调度引擎（SmartScheduler）: 0/6
- 6.4 屏幕采集调度器（ScreenCaptureScheduler）: 0/5
- 6.5 对话触发器（ConversationTrigger）: 0/5
- 6.6 单元测试与示例: 0/6

---

## 技术依赖和注意事项

### 外部依赖库
- **OpenCV**: 用于CV处理、图像处理、模板匹配、特征点检测等
- **ONNX Runtime / TensorRT**: 用于YOLO模型推理
- **Tesseract / EasyOCR**: 用于OCR文本提取（可选）
- **音频处理库**: 用于音频预处理、VAD等（如FFmpeg、librosa）
- **平台特定库**:
  - Windows: DXGI、GDI+、Windows API
  - Linux: X11、Wayland、libav
  - macOS: CoreGraphics、AVFoundation

### 性能优化注意事项
1. **GPU加速**: 充分利用GPU进行图像处理和模型推理，减少CPU负担
2. **多线程**: 合理使用多线程进行并行处理，注意线程安全
3. **内存管理**: 及时释放大图像和模型数据，避免内存泄漏
4. **缓存策略**: 合理使用缓存（图像缓存、模型结果缓存等）
5. **降采样**: 在保证精度的前提下，使用降采样降低处理负载
6. **异步处理**: 对于耗时操作（如VLM调用），使用异步处理避免阻塞

### 配置管理
- 所有模块的参数都应通过 `ConfigManager` 进行配置
- 支持配置文件和环境变量两种配置方式
- 关键参数包括：
  - 采集频率、处理频率
  - 模型路径、置信度阈值
  - 调度策略参数
  - 游戏模式检测配置
  - 触发规则配置

### 错误处理
- 统一使用 `ErrorHandler` 进行错误处理
- 所有外部API调用都应包含重试机制
- 处理资源不足的情况（GPU内存不足、网络异常等）
- 记录详细的错误日志，便于问题排查

---

*最后更新: 2026年1月6日*