# Phase 4ï¼šæœåŠ¡ç®¡ç†å±‚ï¼ˆService Management Layerï¼‰è¯¦ç»†ä»»åŠ¡æ¸…å•

æœ¬æ–‡æ¡£æ˜¯é˜¶æ®µå››æœåŠ¡ç®¡ç†å±‚çš„è¯¦ç»†å¼€å‘ä»»åŠ¡æ¸…å•ï¼ŒåŸºäºã€ŠæœåŠ¡å±‚è®¾è®¡æ–¹æ¡ˆã€‹åˆ¶å®šï¼Œå¹¶ä»¥ Phase1ã€Phase2ã€Phase3 å·²å®Œæˆçš„åŸºç¡€è®¾æ–½å±‚ã€API å®¢æˆ·ç«¯å±‚å’Œæ ¸å¿ƒç®¡ç†å±‚ä¸ºä¾èµ–ã€‚

> **å‚è€ƒä¿¡æ¯**ï¼š
> - è®¾è®¡æ–¹æ¡ˆï¼š`docs/design/æœåŠ¡å±‚è®¾è®¡æ–¹æ¡ˆ.md`
> - Phase1 è¯¦ç»†æ¸…å•ï¼š`docs/todolists/service_layer/TODO_Phase1_åŸºç¡€è®¾æ–½å±‚.md`
> - Phase2 è¯¦ç»†æ¸…å•ï¼š`docs/todolists/service_layer/TODO_Phase2_APIå®¢æˆ·ç«¯å±‚.md`
> - Phase3 è¯¦ç»†æ¸…å•ï¼š`docs/todolists/service_layer/TODO_Phase3_æ ¸å¿ƒç®¡ç†å±‚.md`
> - æ€»ä½“ä»»åŠ¡æ¸…å•ï¼š`docs/todolists/TODO_æœåŠ¡å±‚å¼€å‘ä»»åŠ¡æ¸…å•.md`

## æ¦‚è¿°

### ç›®æ ‡
- å®ç° **è¯·æ±‚ç®¡ç†å™¨ï¼ˆRequestManagerï¼‰**ï¼šç®¡ç†è¯·æ±‚é˜Ÿåˆ—ã€å¹¶å‘æ§åˆ¶å’Œè¯·æ±‚è°ƒåº¦ï¼Œç¡®ä¿APIè°ƒç”¨é«˜æ•ˆä¸”ä¸è¶…å‡ºé™æµã€‚
- å®ç° **å“åº”å¤„ç†å™¨ï¼ˆResponseHandlerï¼‰**ï¼šç»Ÿä¸€å¤„ç†APIå“åº”ï¼ŒåŒ…æ‹¬æµå¼å“åº”è§£æã€å“åº”éªŒè¯å’Œç¼“å­˜é›†æˆã€‚
- å®ç° **ç¼“å­˜ç®¡ç†å™¨ï¼ˆCacheManagerï¼‰**ï¼šç¼“å­˜å¸¸è§è¯·æ±‚çš„å“åº”ï¼Œå‡å°‘APIè°ƒç”¨æ¬¡æ•°ï¼Œæé«˜å“åº”é€Ÿåº¦ã€‚

### éç›®æ ‡ï¼ˆæ˜ç¡®ç•™åˆ°åç»­Phaseï¼‰
- å·¥å…·è°ƒç”¨/MCPæœåŠ¡ï¼ˆPhase5ï¼‰ã€‚
- å¤šæ¨¡æ€æœåŠ¡ï¼ˆPhase6ï¼‰ã€‚
- æœåŠ¡å±‚ä¸»æ¥å£æ•´åˆï¼ˆPhase7ï¼‰ã€‚

### ä¾èµ–ä¸å…³é”®ç»„ä»¶ï¼ˆPhase4 å‰ç½®ï¼‰
- [x] Phase1 å·²æä¾›ï¼š
  - `ConfigManager`ï¼šé…ç½®æ–‡ä»¶åŠ è½½å’Œç¯å¢ƒå˜é‡æ”¯æŒã€‚
  - `types::TaskType`ã€`types::TaskPriority`ã€`types::ChatRequest`ã€`types::ChatResponse` ç­‰åŸºç¡€æ•°æ®ç»“æ„ã€‚
  - `ErrorHandler`ï¼šç»Ÿä¸€é”™è¯¯å¤„ç†å’Œé‡è¯•ç­–ç•¥ã€‚
  - `utils::TokenCounter`ï¼šTokenè®¡æ•°å·¥å…·ã€‚
- [x] Phase2 å·²æä¾›ï¼š
  - `APIClient`ï¼šåŒæ­¥/å¼‚æ­¥/æµå¼ API è°ƒç”¨èƒ½åŠ›ã€‚
- [x] Phase3 å·²æä¾›ï¼š
  - `ModelManager`ï¼šæ¨¡å‹é…ç½®å’Œæ€§èƒ½ç»Ÿè®¡ã€‚
  - `TaskRouter`ï¼šä»»åŠ¡è·¯ç”±å’Œæ¨¡å‹é€‰æ‹©ã€‚
  - `ContextManager`ï¼šä¸Šä¸‹æ–‡æ„å»ºå’Œç®¡ç†ã€‚

---

## 4.1 è¯·æ±‚ç®¡ç†å™¨ï¼ˆRequestManagerï¼‰

### 4.1.1 ä»»åŠ¡æ¦‚è¿°
å®ç°è¯·æ±‚é˜Ÿåˆ—ç®¡ç†ã€å¹¶å‘æ§åˆ¶ã€è¯·æ±‚è°ƒåº¦å’Œè¶…æ—¶ç®¡ç†ï¼Œç¡®ä¿APIè°ƒç”¨é«˜æ•ˆä¸”ä¸è¶…å‡ºé™æµã€‚

### 4.1.2 æ–‡ä»¶ç»“æ„ï¼ˆå»ºè®®ï¼‰
```
include/naw/desktop_pet/service/
â””â”€â”€ RequestManager.h

src/naw/desktop_pet/service/
â””â”€â”€ RequestManager.cpp
```

### 4.1.3 è¯¦ç»†ä»»åŠ¡æ¸…å•

#### 4.1.3.1 è¯·æ±‚é˜Ÿåˆ—å®ç°
- [x] **ä¼˜å…ˆçº§é˜Ÿåˆ—æ•°æ®ç»“æ„è®¾è®¡**
  - [x] å®šä¹‰ `RequestItem` ç»“æ„ä½“
    - [x] `requestId`ï¼ˆè¯·æ±‚IDï¼Œå”¯ä¸€æ ‡è¯†ï¼‰
    - [x] `request`ï¼ˆChatRequestå¯¹è±¡ï¼‰
    - [x] `taskType`ï¼ˆä»»åŠ¡ç±»å‹ï¼‰
    - [x] `priority`ï¼ˆä»»åŠ¡ä¼˜å…ˆçº§ï¼‰
    - [x] `modelId`ï¼ˆé€‰å®šçš„æ¨¡å‹IDï¼‰
    - [x] `timestamp`ï¼ˆæäº¤æ—¶é—´ï¼‰
    - [x] `promise`ï¼ˆstd::promise<ChatResponse>ï¼Œç”¨äºå¼‚æ­¥è¿”å›ç»“æœï¼‰
    - [x] `cancelToken`ï¼ˆå–æ¶ˆä»¤ç‰Œï¼Œå¯é€‰ï¼‰
  - [x] å®šä¹‰ä¼˜å…ˆçº§æ¯”è¾ƒå™¨ï¼ˆ`CompareRequestPriority`ï¼‰
    - [x] Critical > High > Normal > Low
    - [x] åŒä¼˜å…ˆçº§æŒ‰æ—¶é—´æˆ³æ’åºï¼ˆFIFOï¼‰
  - [x] ä½¿ç”¨ `std::priority_queue` æˆ–è‡ªå®šä¹‰ä¼˜å…ˆçº§é˜Ÿåˆ—å®ç°

- [x] **è¯·æ±‚å…¥é˜Ÿ/å‡ºé˜Ÿ**
  - [x] å®ç° `enqueueRequest()` æ–¹æ³•
    - [x] ç”Ÿæˆå”¯ä¸€è¯·æ±‚IDï¼ˆUUIDæˆ–æ—¶é—´æˆ³+éšæœºæ•°ï¼‰
    - [x] åˆ›å»º `RequestItem` å¯¹è±¡
    - [x] å°†è¯·æ±‚æ·»åŠ åˆ°ä¼˜å…ˆçº§é˜Ÿåˆ—
    - [x] è¿”å› `std::future<ChatResponse>`ï¼ˆé€šè¿‡ promiseï¼‰
    - [x] çº¿ç¨‹å®‰å…¨ï¼ˆä½¿ç”¨ mutex ä¿æŠ¤ï¼‰
  - [x] å®ç° `dequeueRequest()` æ–¹æ³•
    - [x] ä»ä¼˜å…ˆçº§é˜Ÿåˆ—å–å‡ºæœ€é«˜ä¼˜å…ˆçº§è¯·æ±‚
    - [x] æ£€æŸ¥è¯·æ±‚æ˜¯å¦å·²å–æ¶ˆ
    - [x] è¿”å› `RequestItem` æˆ– `std::nullopt`ï¼ˆé˜Ÿåˆ—ä¸ºç©ºæ—¶ï¼‰
    - [x] çº¿ç¨‹å®‰å…¨

- [x] **é˜Ÿåˆ—å¤§å°é™åˆ¶**
  - [x] ä» `ConfigManager` è¯»å– `request_manager.max_queue_size` é…ç½®
  - [x] å®ç°é˜Ÿåˆ—å¤§å°æ£€æŸ¥ï¼ˆ`isQueueFull()`ï¼‰
  - [x] åœ¨å…¥é˜Ÿæ—¶æ£€æŸ¥é˜Ÿåˆ—å¤§å°
    - [x] é˜Ÿåˆ—æ»¡æ—¶è¿”å›é”™è¯¯æˆ–ç­‰å¾…ï¼ˆå¯é€‰ï¼šé˜»å¡æˆ–ç«‹å³è¿”å›ï¼‰
    - [x] æ”¯æŒé…ç½®é˜Ÿåˆ—æ»¡æ—¶çš„ç­–ç•¥ï¼ˆæ‹’ç»/ç­‰å¾…/ä¸¢å¼ƒä½ä¼˜å…ˆçº§ï¼‰
  - [x] å®ç°é˜Ÿåˆ—ç»Ÿè®¡ï¼ˆå½“å‰é˜Ÿåˆ—å¤§å°ã€æœ€å¤§é˜Ÿåˆ—å¤§å°ï¼‰

**éªŒæ”¶æ ‡å‡†**ï¼š
- å•æµ‹éªŒè¯ï¼šè¯·æ±‚æŒ‰ä¼˜å…ˆçº§æ­£ç¡®å…¥é˜Ÿå’Œå‡ºé˜Ÿã€‚
- å•æµ‹éªŒè¯ï¼šé˜Ÿåˆ—å¤§å°é™åˆ¶ç”Ÿæ•ˆï¼ˆè¶…è¿‡é™åˆ¶æ—¶æ‹’ç»æˆ–ç­‰å¾…ï¼‰ã€‚
- å•æµ‹éªŒè¯ï¼šçº¿ç¨‹å®‰å…¨ï¼ˆå¹¶å‘å…¥é˜Ÿ/å‡ºé˜Ÿæ— ç«æ€æ¡ä»¶ï¼‰ã€‚

#### 4.1.3.2 å¹¶å‘æ§åˆ¶å™¨å®ç°
- [x] **æŒ‰æ¨¡å‹é™åˆ¶å¹¶å‘æ•°**
  - [x] å®šä¹‰å¹¶å‘æ§åˆ¶ç»“æ„ï¼ˆ`ConcurrencyController`ï¼‰
    - [x] æŒ‰æ¨¡å‹IDè·Ÿè¸ªå½“å‰å¹¶å‘æ•°ï¼ˆ`modelId -> currentConcurrency`ï¼‰
    - [x] ä» `ModelConfig` è¯»å– `maxConcurrentRequests` é™åˆ¶
    - [x] ä½¿ç”¨ `std::atomic` æˆ– `std::mutex` ä¿æŠ¤å¹¶å‘è®¡æ•°
  - [x] å®ç° `checkConcurrencyLimit(const std::string& modelId)` æ–¹æ³•
    - [x] è·å–æ¨¡å‹çš„æœ€å¤§å¹¶å‘æ•°ï¼ˆä» `ModelManager`ï¼‰
    - [x] è·å–å½“å‰å¹¶å‘æ•°
    - [x] è¿”å›æ˜¯å¦å¯æ¥å—æ–°è¯·æ±‚ï¼ˆ`currentConcurrency < maxConcurrentRequests`ï¼‰
  - [x] å®ç° `acquireConcurrencySlot(const std::string& modelId)` æ–¹æ³•
    - [x] æ£€æŸ¥å¹¶å‘é™åˆ¶
    - [x] é€’å¢å½“å‰å¹¶å‘æ•°
    - [x] è¿”å›æ˜¯å¦æˆåŠŸè·å–æ§½ä½
  - [x] å®ç° `releaseConcurrencySlot(const std::string& modelId)` æ–¹æ³•
    - [x] é€’å‡å½“å‰å¹¶å‘æ•°
    - [x] ç¡®ä¿å¹¶å‘æ•°ä¸ä¸ºè´Ÿ

- [x] **å¹¶å‘è¯·æ±‚è®¡æ•°**
  - [x] å®ç°å…¨å±€å¹¶å‘è¯·æ±‚è®¡æ•°ï¼ˆæ‰€æœ‰æ¨¡å‹çš„æ€»å¹¶å‘æ•°ï¼‰
  - [x] å®ç°æŒ‰æ¨¡å‹çš„å¹¶å‘è¯·æ±‚è®¡æ•°
  - [x] å®ç°å¹¶å‘ç»Ÿè®¡æŸ¥è¯¢æ¥å£
    - [x] `getCurrentConcurrency(const std::string& modelId)` - è·å–æŒ‡å®šæ¨¡å‹çš„å½“å‰å¹¶å‘æ•°
    - [x] `getTotalConcurrency()` - è·å–å…¨å±€æ€»å¹¶å‘æ•°
    - [x] `getConcurrencyLimit(const std::string& modelId)` - è·å–æŒ‡å®šæ¨¡å‹çš„å¹¶å‘é™åˆ¶

- [x] **å¹¶å‘é™åˆ¶æ£€æŸ¥**
  - [x] åœ¨è¯·æ±‚è°ƒåº¦å‰æ£€æŸ¥å¹¶å‘é™åˆ¶
  - [x] å¦‚æœè¾¾åˆ°å¹¶å‘é™åˆ¶ï¼Œå°†è¯·æ±‚ä¿ç•™åœ¨é˜Ÿåˆ—ä¸­
  - [x] å®ç°å¹¶å‘é™åˆ¶ç­‰å¾…æœºåˆ¶ï¼ˆå¯é€‰ï¼šå®šæœŸæ£€æŸ¥æˆ–äº‹ä»¶é€šçŸ¥ï¼‰
  - [x] æ”¯æŒè¶…æ—¶ï¼ˆç­‰å¾…æ—¶é—´è¿‡é•¿æ—¶è¿”å›é”™è¯¯ï¼‰

**éªŒæ”¶æ ‡å‡†**ï¼š
- å•æµ‹éªŒè¯ï¼šå¹¶å‘é™åˆ¶ç”Ÿæ•ˆï¼ˆè¶…è¿‡é™åˆ¶æ—¶è¯·æ±‚è¢«é˜»å¡ï¼‰ã€‚
- å•æµ‹éªŒè¯ï¼šå¹¶å‘è®¡æ•°æ­£ç¡®ï¼ˆè¯·æ±‚å¼€å§‹/ç»“æŸæ—¶è®¡æ•°æ›´æ–°ï¼‰ã€‚
- å•æµ‹éªŒè¯ï¼šå¤šä¸ªæ¨¡å‹ç‹¬ç«‹é™åˆ¶å¹¶å‘ï¼ˆæ¨¡å‹Açš„å¹¶å‘ä¸å½±å“æ¨¡å‹Bï¼‰ã€‚

#### 4.1.3.3 è¯·æ±‚è°ƒåº¦å™¨å®ç°
- [x] **é˜Ÿåˆ—å¤„ç†å¾ªç¯**
  - [x] å®šä¹‰å·¥ä½œçº¿ç¨‹ï¼ˆ`m_workerThread`ï¼‰
  - [x] å®ç° `processQueue()` æ–¹æ³•
    - [x] å¾ªç¯å¤„ç†é˜Ÿåˆ—ä¸­çš„è¯·æ±‚
    - [x] æ£€æŸ¥åœæ­¢æ ‡å¿—ï¼ˆ`m_running`ï¼‰
    - [x] ä»é˜Ÿåˆ—å–å‡ºè¯·æ±‚
    - [x] æ£€æŸ¥å¹¶å‘é™åˆ¶
    - [x] åˆ†å‘è¯·æ±‚åˆ°APIå®¢æˆ·ç«¯
    - [x] å¤„ç†è¯·æ±‚ç»“æœï¼ˆæˆåŠŸ/å¤±è´¥ï¼‰
  - [x] å®ç° `start()` æ–¹æ³•
    - [x] å¯åŠ¨å·¥ä½œçº¿ç¨‹
    - [x] è®¾ç½®è¿è¡Œæ ‡å¿—
  - [x] å®ç° `stop()` æ–¹æ³•
    - [x] è®¾ç½®åœæ­¢æ ‡å¿—
    - [x] ç­‰å¾…å·¥ä½œçº¿ç¨‹ç»“æŸ
    - [x] æ¸…ç†èµ„æº

- [x] **è¯·æ±‚åˆ†å‘**
  - [x] å®ç° `dispatchRequest(const RequestItem& item)` æ–¹æ³•
    - [x] è·å–æ¨¡å‹é…ç½®ï¼ˆä» `ModelManager`ï¼‰
    - [x] æ£€æŸ¥å¹¶å‘é™åˆ¶ï¼ˆ`acquireConcurrencySlot`ï¼‰
    - [x] è°ƒç”¨ `APIClient::chatAsync()` æˆ– `APIClient::chatStream()`
    - [x] å¤„ç†å¼‚æ­¥ç»“æœ
      - [x] æˆåŠŸï¼šè®¾ç½® promise å€¼
      - [x] å¤±è´¥ï¼šè®¾ç½® promise å¼‚å¸¸æˆ–é”™è¯¯å“åº”
    - [x] é‡Šæ”¾å¹¶å‘æ§½ä½ï¼ˆ`releaseConcurrencySlot`ï¼‰
    - [x] æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
  - [x] æ”¯æŒæµå¼è¯·æ±‚åˆ†å‘
    - [x] å¤„ç†æµå¼å›è°ƒ
    - [x] èšåˆæµå¼å“åº”
    - [x] æœ€ç»ˆè®¾ç½® promise å€¼

- [x] **è¶…æ—¶ç®¡ç†**
  - [x] ä» `ConfigManager` è¯»å– `request_manager.default_timeout_ms` é…ç½®
  - [x] ä» `ModelConfig` è¯»å–æ¨¡å‹ç‰¹å®šçš„è¶…æ—¶é…ç½®ï¼ˆå¯é€‰ï¼‰
  - [x] å®ç°è¯·æ±‚è¶…æ—¶æ£€æŸ¥
    - [x] è®°å½•è¯·æ±‚å¼€å§‹æ—¶é—´
    - [x] å®šæœŸæ£€æŸ¥è¯·æ±‚æ˜¯å¦è¶…æ—¶
    - [x] è¶…æ—¶åå–æ¶ˆè¯·æ±‚ï¼ˆå¦‚æœæ”¯æŒï¼‰
  - [x] å®ç°è¶…æ—¶å¤„ç†
    - [x] è®¾ç½® promise å¼‚å¸¸ï¼ˆ`std::future_error` æˆ–è‡ªå®šä¹‰è¶…æ—¶é”™è¯¯ï¼‰
    - [x] é‡Šæ”¾å¹¶å‘æ§½ä½
    - [x] æ›´æ–°ç»Ÿè®¡ä¿¡æ¯ï¼ˆå¤±è´¥è®¡æ•°ï¼‰
    - [x] è®°å½•è¶…æ—¶æ—¥å¿—

**éªŒæ”¶æ ‡å‡†**ï¼š
- å•æµ‹éªŒè¯ï¼šè¯·æ±‚æŒ‰ä¼˜å…ˆçº§æ­£ç¡®è°ƒåº¦ã€‚
- å•æµ‹éªŒè¯ï¼šå¹¶å‘é™åˆ¶ç”Ÿæ•ˆï¼ˆè¾¾åˆ°é™åˆ¶æ—¶è¯·æ±‚ç­‰å¾…ï¼‰ã€‚
- å•æµ‹éªŒè¯ï¼šè¶…æ—¶ç®¡ç†æ­£ç¡®ï¼ˆè¶…æ—¶åè¯·æ±‚è¢«å–æ¶ˆå¹¶è¿”å›é”™è¯¯ï¼‰ã€‚

#### 4.1.3.4 è¯·æ±‚å–æ¶ˆæœºåˆ¶
- [x] **å–æ¶ˆä»¤ç‰Œå®ç°**
  - [x] å®šä¹‰ `CancelToken` ç»“æ„ï¼ˆæˆ–ä½¿ç”¨ `HttpClient::CancelToken`ï¼‰
    - [x] `isCancelled()` - æ£€æŸ¥æ˜¯å¦å·²å–æ¶ˆ
    - [x] `cancel()` - å–æ¶ˆè¯·æ±‚
  - [x] åœ¨ `RequestItem` ä¸­å­˜å‚¨ `CancelToken`
  - [x] å®ç°è¯·æ±‚å–æ¶ˆæ¥å£ï¼ˆ`cancelRequest(const std::string& requestId)`ï¼‰
    - [x] æŸ¥æ‰¾è¯·æ±‚ï¼ˆåœ¨é˜Ÿåˆ—ä¸­æˆ–æ­£åœ¨å¤„ç†ä¸­ï¼‰
    - [x] è®¾ç½®å–æ¶ˆæ ‡å¿—
    - [x] å¦‚æœè¯·æ±‚åœ¨é˜Ÿåˆ—ä¸­ï¼Œä»é˜Ÿåˆ—ç§»é™¤
    - [x] å¦‚æœè¯·æ±‚æ­£åœ¨å¤„ç†ï¼Œè°ƒç”¨ `APIClient` çš„å–æ¶ˆæ–¹æ³•ï¼ˆå¦‚æœæ”¯æŒï¼‰
    - [x] è®¾ç½® promise å¼‚å¸¸ï¼ˆå–æ¶ˆé”™è¯¯ï¼‰
    - [x] é‡Šæ”¾å¹¶å‘æ§½ä½

- [x] **å–æ¶ˆçŠ¶æ€è·Ÿè¸ª**
  - [x] ç»´æŠ¤å·²å–æ¶ˆè¯·æ±‚çš„é›†åˆï¼ˆå¯é€‰ï¼Œç”¨äºç»Ÿè®¡ï¼‰
  - [x] å®ç°å–æ¶ˆç»Ÿè®¡ï¼ˆå–æ¶ˆè¯·æ±‚æ•°ã€å–æ¶ˆåŸå› ç­‰ï¼‰

**éªŒæ”¶æ ‡å‡†**ï¼š
- å•æµ‹éªŒè¯ï¼šé˜Ÿåˆ—ä¸­çš„è¯·æ±‚å¯ä»¥è¢«å–æ¶ˆã€‚
- å•æµ‹éªŒè¯ï¼šæ­£åœ¨å¤„ç†çš„è¯·æ±‚å¯ä»¥è¢«å–æ¶ˆï¼ˆå¦‚æœAPIå®¢æˆ·ç«¯æ”¯æŒï¼‰ã€‚
- å•æµ‹éªŒè¯ï¼šå–æ¶ˆå promise æ­£ç¡®è®¾ç½®å¼‚å¸¸ã€‚

#### 4.1.3.5 è¯·æ±‚ç»Ÿè®¡
- [x] **ç»Ÿè®¡æ•°æ®ç»“æ„**
  - [x] å®šä¹‰ `RequestStatistics` ç»“æ„ä½“
    - [x] `totalRequests`ï¼ˆæ€»è¯·æ±‚æ•°ï¼‰
    - [x] `completedRequests`ï¼ˆå®Œæˆè¯·æ±‚æ•°ï¼‰
    - [x] `failedRequests`ï¼ˆå¤±è´¥è¯·æ±‚æ•°ï¼‰
    - [x] `cancelledRequests`ï¼ˆå–æ¶ˆè¯·æ±‚æ•°ï¼‰
    - [x] `averageResponseTimeMs`ï¼ˆå¹³å‡å“åº”æ—¶é—´ï¼Œæ¯«ç§’ï¼‰
    - [x] `minResponseTimeMs`ï¼ˆæœ€å°å“åº”æ—¶é—´ï¼‰
    - [x] `maxResponseTimeMs`ï¼ˆæœ€å¤§å“åº”æ—¶é—´ï¼‰
    - [x] `requestsPerModel`ï¼ˆæŒ‰æ¨¡å‹çš„è¯·æ±‚æ•°ç»Ÿè®¡ï¼‰
    - [x] `queueSize`ï¼ˆå½“å‰é˜Ÿåˆ—å¤§å°ï¼‰
    - [x] `maxQueueSize`ï¼ˆæœ€å¤§é˜Ÿåˆ—å¤§å°ï¼‰
  - [x] ä½¿ç”¨çº¿ç¨‹å®‰å…¨çš„æ•°æ®ç»“æ„ï¼ˆ`std::atomic` æˆ– `std::mutex`ï¼‰

- [x] **ç»Ÿè®¡æ›´æ–°**
  - [x] åœ¨è¯·æ±‚æäº¤æ—¶æ›´æ–°ç»Ÿè®¡ï¼ˆ`totalRequests++`ï¼‰
  - [x] åœ¨è¯·æ±‚å®Œæˆæ—¶æ›´æ–°ç»Ÿè®¡ï¼ˆ`completedRequests++`ï¼Œå“åº”æ—¶é—´ï¼‰
  - [x] åœ¨è¯·æ±‚å¤±è´¥æ—¶æ›´æ–°ç»Ÿè®¡ï¼ˆ`failedRequests++`ï¼‰
  - [x] åœ¨è¯·æ±‚å–æ¶ˆæ—¶æ›´æ–°ç»Ÿè®¡ï¼ˆ`cancelledRequests++`ï¼‰
  - [x] æŒ‰æ¨¡å‹ç»Ÿè®¡è¯·æ±‚æ•°ï¼ˆ`requestsPerModel[modelId]++`ï¼‰

- [x] **ç»Ÿè®¡æŸ¥è¯¢æ¥å£**
  - [x] å®ç° `getStatistics()` æ–¹æ³•
    - [x] è¿”å›å®Œæ•´çš„ `RequestStatistics` ç»“æ„
    - [x] è®¡ç®—å¹³å‡å“åº”æ—¶é—´ï¼ˆ`totalResponseTime / completedRequests`ï¼‰
  - [x] å®ç° `getQueueStatistics()` æ–¹æ³•
    - [x] è¿”å›é˜Ÿåˆ—ç›¸å…³ç»Ÿè®¡ï¼ˆå½“å‰å¤§å°ã€æœ€å¤§å¤§å°ã€ç­‰å¾…æ—¶é—´ç­‰ï¼‰

**éªŒæ”¶æ ‡å‡†**ï¼š
- å•æµ‹éªŒè¯ï¼šç»Ÿè®¡ä¿¡æ¯æ­£ç¡®æ›´æ–°ï¼ˆè¯·æ±‚æäº¤/å®Œæˆ/å¤±è´¥æ—¶ï¼‰ã€‚
- å•æµ‹éªŒè¯ï¼šå¹³å‡å“åº”æ—¶é—´è®¡ç®—æ­£ç¡®ã€‚
- å•æµ‹éªŒè¯ï¼šæŒ‰æ¨¡å‹ç»Ÿè®¡å‡†ç¡®ã€‚

---

## 4.2 å“åº”å¤„ç†å™¨ï¼ˆResponseHandlerï¼‰

### 4.2.1 ä»»åŠ¡æ¦‚è¿°
ç»Ÿä¸€å¤„ç†APIå“åº”ï¼ŒåŒ…æ‹¬æµå¼å“åº”å¤„ç†ã€å“åº”éªŒè¯å’Œç¼“å­˜é›†æˆã€‚

### 4.2.2 æ–‡ä»¶ç»“æ„ï¼ˆå»ºè®®ï¼‰
```
include/naw/desktop_pet/service/
â””â”€â”€ ResponseHandler.h

src/naw/desktop_pet/service/
â””â”€â”€ ResponseHandler.cpp
```

### 4.2.3 è¯¦ç»†ä»»åŠ¡æ¸…å•

#### 4.2.3.1 æµå¼å“åº”å¤„ç†
- [x] **SSEæ•°æ®æµè§£æ**
  - [x] å¤ç”¨ Phase2 ä¸­ `APIClient` çš„ SSE è§£æé€»è¾‘ï¼ˆæˆ–æå–ä¸ºç‹¬ç«‹ç»„ä»¶ï¼‰
  - [x] å®ç° `parseSSEChunk()` æ–¹æ³•ï¼ˆé€šè¿‡ `SseDecoder` ç±»å®ç°ï¼‰
    - [x] å¤„ç† `\n\n` åˆ†éš”çš„äº‹ä»¶
    - [x] å¤„ç†å¤šè¡Œ `data:` æ‹¼æ¥
    - [x] å¤„ç† `data: [DONE]` ç»ˆæ­¢æ ‡è®°
    - [x] å¤„ç†æ–­è¡Œ/ç²˜åŒ…ï¼ˆchunk å¯èƒ½ä»»æ„åˆ‡å‰²ï¼‰
  - [x] è¾“å‡ºï¼šæ¯ä¸ª event çš„ JSON payloadï¼ˆstringï¼‰

- [x] **å¢é‡å†…å®¹æå–**
  - [x] å®ç° `extractTextDelta()` æ–¹æ³•ï¼ˆé€šè¿‡ `ChatStreamAggregator::onChunkJson()` å®ç°ï¼‰
    - [x] ä» SSE event JSON ä¸­æå– `choices[0].delta.content`
    - [x] è¿”å›å¢é‡æ–‡æœ¬å†…å®¹ï¼ˆ`std::string_view` æˆ– `std::string`ï¼‰
  - [x] å®ç° `extractToolCallDelta()` æ–¹æ³•ï¼ˆé€šè¿‡ `ChatStreamAggregator::onChunkJson()` å®ç°ï¼‰
    - [x] ä» SSE event JSON ä¸­æå– `choices[0].delta.tool_calls`
    - [x] è¿”å›å¢é‡å·¥å…·è°ƒç”¨æ•°æ®ï¼ˆ`ToolCallDelta` ç»“æ„ï¼‰
  - [x] å®ç° `extractFinishReason()` æ–¹æ³•ï¼ˆé€šè¿‡ `ChatStreamAggregator::onChunkJson()` å®ç°ï¼‰
    - [x] ä» SSE event JSON ä¸­æå– `choices[0].finish_reason`
    - [x] è¿”å›å®ŒæˆåŸå› ï¼ˆ`stop`ã€`tool_calls`ã€`length` ç­‰ï¼‰

- [x] **æµå¼å›è°ƒç®¡ç†**
  - [x] å®šä¹‰æµå¼å›è°ƒæ¥å£ï¼ˆ`StreamCallbacks`ï¼‰
    - [x] `onTextDelta(std::string_view delta)` - æ–‡æœ¬å¢é‡å›è°ƒ
    - [x] `onToolCallDelta(const ToolCallDelta& delta)` - å·¥å…·è°ƒç”¨å¢é‡å›è°ƒ
    - [x] `onComplete(const ChatResponse& response)` - å®Œæˆå›è°ƒ
    - [x] `onError(const ErrorInfo& error)` - é”™è¯¯å›è°ƒ
  - [x] å®ç° `handleStreamResponse()` æ–¹æ³•
    - [x] æ¥æ”¶ SSE æ•°æ®æµ
    - [x] è§£ææ¯ä¸ª chunk
    - [x] èšåˆå¢é‡å†…å®¹
    - [x] è°ƒç”¨ç›¸åº”çš„å›è°ƒå‡½æ•°
    - [x] å¤„ç†å®Œæˆå’Œé”™è¯¯æƒ…å†µ
  - [x] å®ç°æµå¼å“åº”èšåˆå™¨ï¼ˆ`ChatStreamAggregator` ç±»ï¼‰
    - [x] ç´¯ç§¯æ–‡æœ¬å†…å®¹ï¼ˆ`m_accumulatedContent`ï¼‰
    - [x] ç´¯ç§¯å·¥å…·è°ƒç”¨ï¼ˆæŒ‰ index/id èšåˆï¼‰
    - [x] æœ€ç»ˆæ„å»ºå®Œæ•´çš„ `ChatResponse` å¯¹è±¡

**éªŒæ”¶æ ‡å‡†**ï¼š
- å•æµ‹éªŒè¯ï¼šSSE æ•°æ®æµè§£ææ­£ç¡®ï¼ˆå¤„ç†å„ç§è¾¹ç•Œæƒ…å†µï¼‰ã€‚
- å•æµ‹éªŒè¯ï¼šå¢é‡å†…å®¹æå–æ­£ç¡®ï¼ˆæ–‡æœ¬å’Œå·¥å…·è°ƒç”¨ï¼‰ã€‚
- å•æµ‹éªŒè¯ï¼šæµå¼å›è°ƒæŒ‰é¡ºåºæ­£ç¡®è°ƒç”¨ã€‚

#### 4.2.3.2 å“åº”éªŒè¯
- [x] **JSONæ ¼å¼éªŒè¯**
  - [x] å®ç° `validateJsonFormat()` æ–¹æ³•
    - [x] æ£€æŸ¥å“åº”æ˜¯å¦ä¸ºæœ‰æ•ˆ JSON
    - [x] ä½¿ç”¨ `nlohmann::json::parse()` è§£æ
    - [x] æ•è· JSON è§£æå¼‚å¸¸
    - [x] è¿”å›éªŒè¯ç»“æœï¼ˆæˆåŠŸ/å¤±è´¥ + é”™è¯¯ä¿¡æ¯ï¼‰
  - [x] å®ç° `validateResponseStructure()` æ–¹æ³•
    - [x] æ£€æŸ¥å¿…éœ€å­—æ®µæ˜¯å¦å­˜åœ¨ï¼ˆ`choices`ã€`usage` ç­‰ï¼‰
    - [x] æ£€æŸ¥å­—æ®µç±»å‹æ˜¯å¦æ­£ç¡®
    - [x] è¿”å›éªŒè¯ç»“æœ

- [x] **å¿…éœ€å­—æ®µæ£€æŸ¥**
  - [x] å®šä¹‰å“åº”å­—æ®µéªŒè¯è§„åˆ™
    - [x] `choices` æ•°ç»„å¿…é¡»å­˜åœ¨ä¸”éç©º
    - [x] `choices[0].message` å¿…é¡»å­˜åœ¨
    - [x] `usage` å¯¹è±¡åº”è¯¥å­˜åœ¨ï¼ˆå¯é€‰ï¼Œä½†å»ºè®®æœ‰ï¼‰
  - [x] å®ç° `checkRequiredFields()` æ–¹æ³•
    - [x] æ£€æŸ¥æ‰€æœ‰å¿…éœ€å­—æ®µ
    - [x] è¿”å›ç¼ºå¤±å­—æ®µåˆ—è¡¨ï¼ˆå¦‚æœæœ‰ï¼‰
  - [x] å®ç°å­—æ®µç±»å‹éªŒè¯
    - [x] `choices` å¿…é¡»æ˜¯æ•°ç»„
    - [x] `usage` å¿…é¡»æ˜¯å¯¹è±¡
    - [x] `prompt_tokens`ã€`completion_tokens`ã€`total_tokens` å¿…é¡»æ˜¯æ•°å­—

- [x] **å“åº”å†…å®¹éªŒè¯**
  - [x] å®ç° `validateResponseContent()` æ–¹æ³•
    - [x] æ£€æŸ¥å“åº”å†…å®¹æ˜¯å¦ä¸ºç©ºï¼ˆå¯¹äºéå·¥å…·è°ƒç”¨å“åº”ï¼‰
    - [x] æ£€æŸ¥å·¥å…·è°ƒç”¨å‚æ•°æ˜¯å¦æœ‰æ•ˆï¼ˆJSONæ ¼å¼ï¼‰
    - [x] æ£€æŸ¥ finish_reason æ˜¯å¦æœ‰æ•ˆ
  - [x] å®ç°å“åº”å®Œæ•´æ€§æ£€æŸ¥
    - [x] æµå¼å“åº”æ˜¯å¦å®Œæ•´ï¼ˆæ”¶åˆ° `[DONE]` æ ‡è®°ï¼‰
    - [x] å·¥å…·è°ƒç”¨æ˜¯å¦å®Œæ•´ï¼ˆæ‰€æœ‰ tool_calls éƒ½æœ‰å®Œæ•´å‚æ•°ï¼‰

**éªŒæ”¶æ ‡å‡†**ï¼š
- å•æµ‹éªŒè¯ï¼šJSON æ ¼å¼éªŒè¯æ­£ç¡®ï¼ˆæœ‰æ•ˆ/æ— æ•ˆ JSON éƒ½èƒ½æ­£ç¡®è¯†åˆ«ï¼‰ã€‚
- å•æµ‹éªŒè¯ï¼šå¿…éœ€å­—æ®µæ£€æŸ¥æ­£ç¡®ï¼ˆç¼ºå¤±å­—æ®µæ—¶è¿”å›é”™è¯¯ï¼‰ã€‚
- å•æµ‹éªŒè¯ï¼šå“åº”å†…å®¹éªŒè¯æ­£ç¡®ï¼ˆç©ºå†…å®¹ã€æ— æ•ˆå·¥å…·è°ƒç”¨ç­‰ï¼‰ã€‚

#### 4.2.3.3 å“åº”ç¼“å­˜é›†æˆ
- [x] **ç¼“å­˜æŸ¥è¯¢é›†æˆ**
  - [x] åœ¨ `ResponseHandler` ä¸­æŒæœ‰ `CacheManager` çš„å¼•ç”¨
  - [x] å®ç° `checkCache()` æ–¹æ³•
    - [x] æ ¹æ®è¯·æ±‚ç”Ÿæˆç¼“å­˜é”®ï¼ˆä½¿ç”¨ `CacheManager::generateKey()`ï¼‰
    - [x] æŸ¥è¯¢ç¼“å­˜ï¼ˆä½¿ç”¨ `CacheManager::get()`ï¼‰
    - [x] å¦‚æœå‘½ä¸­ï¼Œè¿”å›ç¼“å­˜çš„å“åº”
    - [x] å¦‚æœæœªå‘½ä¸­ï¼Œè¿”å› `std::nullopt`
  - [x] åœ¨å“åº”å¤„ç†æµç¨‹ä¸­é›†æˆç¼“å­˜æŸ¥è¯¢
    - [x] åœ¨å¤„ç†è¯·æ±‚å‰å…ˆæŸ¥è¯¢ç¼“å­˜
    - [x] å‘½ä¸­ç¼“å­˜æ—¶ç›´æ¥è¿”å›ï¼Œè·³è¿‡ API è°ƒç”¨

- [x] **ç¼“å­˜å­˜å‚¨é›†æˆ**
  - [x] å®ç° `storeCache()` æ–¹æ³•
    - [x] æ ¹æ®è¯·æ±‚ç”Ÿæˆç¼“å­˜é”®
    - [x] å­˜å‚¨å“åº”åˆ°ç¼“å­˜ï¼ˆä½¿ç”¨ `CacheManager::put()`ï¼‰
    - [x] åªç¼“å­˜éæµå¼å“åº”ï¼ˆæµå¼å“åº”ä¸é€‚åˆç¼“å­˜ï¼‰
    - [x] åªç¼“å­˜æˆåŠŸçš„å“åº”ï¼ˆå¤±è´¥å“åº”ä¸ç¼“å­˜ï¼‰
  - [x] åœ¨å“åº”å¤„ç†æµç¨‹ä¸­é›†æˆç¼“å­˜å­˜å‚¨
    - [x] API è°ƒç”¨æˆåŠŸåå­˜å‚¨å“åº”
    - [x] æ£€æŸ¥ç¼“å­˜é…ç½®ï¼ˆæ˜¯å¦å¯ç”¨ç¼“å­˜ï¼‰

- [x] **ç¼“å­˜ç­–ç•¥é…ç½®**
  - [x] ä» `ConfigManager` è¯»å–ç¼“å­˜é…ç½®
    - [x] `cache.enabled` - æ˜¯å¦å¯ç”¨ç¼“å­˜
    - [x] `cache.default_ttl_seconds` - é»˜è®¤ TTL
  - [x] å®ç°ç¼“å­˜æ¡ä»¶åˆ¤æ–­ï¼ˆ`shouldCache()` æ–¹æ³•ï¼‰
    - [x] åªç¼“å­˜ç¡®å®šæ€§è¯·æ±‚ï¼ˆ`temperature=0` æˆ–æ¥è¿‘ 0ï¼‰
    - [x] ä¸ç¼“å­˜åŒ…å«å·¥å…·è°ƒç”¨çš„è¯·æ±‚ï¼ˆå¯é€‰ï¼Œæ ¹æ®é…ç½®ï¼‰
    - [x] ä¸ç¼“å­˜æµå¼è¯·æ±‚

**éªŒæ”¶æ ‡å‡†**ï¼š
- å•æµ‹éªŒè¯ï¼šç¼“å­˜æŸ¥è¯¢é›†æˆæ­£ç¡®ï¼ˆå‘½ä¸­ç¼“å­˜æ—¶ç›´æ¥è¿”å›ï¼‰ã€‚
- å•æµ‹éªŒè¯ï¼šç¼“å­˜å­˜å‚¨é›†æˆæ­£ç¡®ï¼ˆæˆåŠŸå“åº”è¢«æ­£ç¡®ç¼“å­˜ï¼‰ã€‚
- å•æµ‹éªŒè¯ï¼šç¼“å­˜ç­–ç•¥ç”Ÿæ•ˆï¼ˆç¬¦åˆæ¡ä»¶çš„è¯·æ±‚è¢«ç¼“å­˜ï¼Œä¸ç¬¦åˆçš„ä¸ç¼“å­˜ï¼‰ã€‚

#### 4.2.3.4 å“åº”ç»Ÿè®¡
- [x] **ç»Ÿè®¡æ•°æ®ç»“æ„**
  - [x] å®šä¹‰ `ResponseStatistics` ç»“æ„ä½“
    - [x] `totalResponses`ï¼ˆæ€»å“åº”æ•°ï¼‰
    - [x] `successfulResponses`ï¼ˆæˆåŠŸå“åº”æ•°ï¼‰
    - [x] `failedResponses`ï¼ˆå¤±è´¥å“åº”æ•°ï¼‰
    - [x] `cachedResponses`ï¼ˆç¼“å­˜å‘½ä¸­æ•°ï¼‰
    - [x] `totalResponseSize`ï¼ˆæ€»å“åº”å¤§å°ï¼Œå­—èŠ‚ï¼‰
    - [x] `streamingResponses`ï¼ˆæµå¼å“åº”æ•°ï¼‰
    - [x] `getAverageResponseSize()` æ–¹æ³•ï¼ˆè®¡ç®—å¹³å‡å“åº”å¤§å°ï¼‰
    - [x] `getCacheHitRate()` æ–¹æ³•ï¼ˆè®¡ç®—ç¼“å­˜å‘½ä¸­ç‡ï¼‰
  - [x] ä½¿ç”¨çº¿ç¨‹å®‰å…¨çš„æ•°æ®ç»“æ„ï¼ˆ`std::mutex` ä¿æŠ¤ï¼‰

- [x] **ç»Ÿè®¡æ›´æ–°**
  - [x] åœ¨å¤„ç†å“åº”æ—¶æ›´æ–°ç»Ÿè®¡
    - [x] `totalResponses++`ï¼ˆåœ¨ `checkCache()` ä¸­ï¼‰
    - [x] æˆåŠŸæ—¶ `successfulResponses++`ï¼ˆé€šè¿‡ `updateStatistics()` æ–¹æ³•ï¼‰
    - [x] å¤±è´¥æ—¶ `failedResponses++`ï¼ˆé€šè¿‡ `updateStatistics()` æ–¹æ³•ï¼‰
    - [x] ç¼“å­˜å‘½ä¸­æ—¶ `cachedResponses++`ï¼ˆåœ¨ `checkCache()` ä¸­ï¼‰
    - [x] æµå¼å“åº”æ—¶ `streamingResponses++`ï¼ˆé€šè¿‡ `updateStatistics()` æ–¹æ³•ï¼‰
    - [x] å“åº”å¤§å°ç»Ÿè®¡ï¼ˆåœ¨ `checkCache()` ä¸­é€šè¿‡ `estimateResponseSize()` æ›´æ–°ï¼‰
  - [x] è®¡ç®—å¹³å‡å“åº”å¤§å°ï¼ˆ`totalResponseSize / totalResponses`ï¼‰

- [x] **ç»Ÿè®¡æŸ¥è¯¢æ¥å£**
  - [x] å®ç° `getStatistics()` æ–¹æ³•
    - [x] è¿”å›å®Œæ•´çš„ `ResponseStatistics` ç»“æ„
  - [x] å®ç°ç¼“å­˜å‘½ä¸­ç‡è®¡ç®—ï¼ˆ`cachedResponses / totalResponses`ï¼Œé€šè¿‡ `getCacheHitRate()` æ–¹æ³•ï¼‰

**éªŒæ”¶æ ‡å‡†**ï¼š
- å•æµ‹éªŒè¯ï¼šç»Ÿè®¡ä¿¡æ¯æ­£ç¡®æ›´æ–°ã€‚
- å•æµ‹éªŒè¯ï¼šç¼“å­˜å‘½ä¸­ç‡è®¡ç®—æ­£ç¡®ã€‚

---

## 4.3 ç¼“å­˜ç®¡ç†å™¨ï¼ˆCacheManagerï¼‰

### 4.3.1 ä»»åŠ¡æ¦‚è¿°
å®ç°åŸºäºè¯·æ±‚å†…å®¹çš„å“åº”ç¼“å­˜ï¼Œå‡å°‘APIè°ƒç”¨æ¬¡æ•°ï¼Œæé«˜å“åº”é€Ÿåº¦ã€‚

### 4.3.2 æ–‡ä»¶ç»“æ„ï¼ˆå»ºè®®ï¼‰
```
include/naw/desktop_pet/service/
â””â”€â”€ CacheManager.h

src/naw/desktop_pet/service/
â””â”€â”€ CacheManager.cpp
```

### 4.3.3 è¯¦ç»†ä»»åŠ¡æ¸…å•

#### 4.3.3.1 ç¼“å­˜é”®ç”Ÿæˆ
- [x] **åŸºäºè¯·æ±‚å†…å®¹çš„å“ˆå¸Œ**
  - [x] å®šä¹‰ `CacheKey` ç»“æ„ä½“
    - [x] `modelId`ï¼ˆæ¨¡å‹IDï¼‰
    - [x] `messagesHash`ï¼ˆæ¶ˆæ¯å†…å®¹çš„å“ˆå¸Œå€¼ï¼‰
    - [x] `temperature`ï¼ˆæ¸©åº¦å‚æ•°ï¼‰
    - [x] `maxTokens`ï¼ˆæœ€å¤§Tokenæ•°ï¼‰
    - [x] `topP`ï¼ˆTop-på‚æ•°ï¼Œå¯é€‰ï¼‰
    - [x] `topK`ï¼ˆTop-kå‚æ•°ï¼Œå¯é€‰ï¼‰
    - [x] `stop`ï¼ˆåœæ­¢åºåˆ—ï¼Œå¯é€‰ï¼‰
  - [x] å®ç° `generateKey(const ChatRequest& request)` æ–¹æ³•
    - [x] åºåˆ—åŒ–æ¶ˆæ¯åˆ—è¡¨ï¼ˆä½¿ç”¨ `ChatMessage::toJson()`ï¼‰
    - [x] è®¡ç®—æ¶ˆæ¯å†…å®¹çš„å“ˆå¸Œå€¼ï¼ˆä½¿ç”¨ `std::hash` æˆ– SHA256ï¼‰
    - [x] ç»„åˆæ‰€æœ‰å‚æ•°ç”Ÿæˆç¼“å­˜é”®
    - [x] è¿”å› `CacheKey` å¯¹è±¡
  - [x] å®ç° `CacheKey` çš„å“ˆå¸Œå‡½æ•°ï¼ˆç”¨äº `std::unordered_map`ï¼‰
    - [x] å®ç° `CacheKeyHash` å‡½æ•°å¯¹è±¡ï¼ˆä½¿ç”¨è‡ªå®šä¹‰å“ˆå¸Œå‡½æ•°å¯¹è±¡é¿å… MSVC ç‰¹åŒ–é—®é¢˜ï¼‰

- [x] **æ¨¡å‹IDã€æ¸©åº¦ç­‰å‚æ•°åŒ…å«**
  - [x] ç¡®ä¿ç¼“å­˜é”®åŒ…å«æ‰€æœ‰å½±å“å“åº”çš„å‚æ•°
    - [x] æ¨¡å‹IDï¼ˆä¸åŒæ¨¡å‹å“åº”ä¸åŒï¼‰
    - [x] æ¸©åº¦å‚æ•°ï¼ˆtemperature å½±å“éšæœºæ€§ï¼‰
    - [x] é‡‡æ ·å‚æ•°ï¼ˆtop_pã€top_k å½±å“è¾“å‡ºï¼‰
    - [x] åœæ­¢åºåˆ—ï¼ˆstop å½±å“è¾“å‡ºé•¿åº¦ï¼‰
    - [x] æœ€å¤§Tokenæ•°ï¼ˆmax_tokens å½±å“è¾“å‡ºé•¿åº¦ï¼‰
  - [x] å®ç°å‚æ•°åºåˆ—åŒ–
    - [x] å°†å‚æ•°ç»„åˆæˆå­—ç¬¦ä¸²
    - [x] è®¡ç®—å“ˆå¸Œå€¼
  - [x] å¤„ç†å¯é€‰å‚æ•°
    - [x] æœªè®¾ç½®çš„å‚æ•°ä½¿ç”¨é»˜è®¤å€¼æˆ–ç‰¹æ®Šæ ‡è®°

- [x] **ç¼“å­˜é”®æ¯”è¾ƒ**
  - [x] å®ç° `CacheKey` çš„ç›¸ç­‰æ¯”è¾ƒè¿ç®—ç¬¦ï¼ˆ`operator==`ï¼‰
    - [x] æ¯”è¾ƒæ‰€æœ‰å­—æ®µ
  - [x] ç¡®ä¿ç¼“å­˜é”®çš„å”¯ä¸€æ€§
    - [x] ç›¸åŒè¯·æ±‚ç”Ÿæˆç›¸åŒç¼“å­˜é”®
    - [x] ä¸åŒè¯·æ±‚ç”Ÿæˆä¸åŒç¼“å­˜é”®

**éªŒæ”¶æ ‡å‡†**ï¼š
- å•æµ‹éªŒè¯ï¼šç›¸åŒè¯·æ±‚ç”Ÿæˆç›¸åŒç¼“å­˜é”®ã€‚
- å•æµ‹éªŒè¯ï¼šä¸åŒè¯·æ±‚ç”Ÿæˆä¸åŒç¼“å­˜é”®ã€‚
- å•æµ‹éªŒè¯ï¼šå‚æ•°å˜åŒ–æ—¶ç¼“å­˜é”®ä¹Ÿå˜åŒ–ã€‚

#### 4.3.3.2 ç¼“å­˜å­˜å‚¨å®ç°
- [x] **å†…å­˜ç¼“å­˜å®ç°**
  - [x] ä½¿ç”¨ `std::unordered_map<CacheKey, CacheEntry, CacheKeyHash>` å­˜å‚¨ç¼“å­˜
  - [x] å®šä¹‰ `CacheEntry` ç»“æ„ä½“
    - [x] `response`ï¼ˆChatResponseå¯¹è±¡ï¼‰
    - [x] `timestamp`ï¼ˆå­˜å‚¨æ—¶é—´æˆ³ï¼‰
    - [x] `ttl`ï¼ˆTime to liveï¼Œç”Ÿå­˜æ—¶é—´ï¼‰
    - [x] `accessCount`ï¼ˆè®¿é—®æ¬¡æ•°ï¼Œå¯é€‰ï¼Œç”¨äºLRUï¼‰
    - [x] `lastAccessTime`ï¼ˆæœ€åè®¿é—®æ—¶é—´ï¼Œå¯é€‰ï¼Œç”¨äºLRUï¼‰
  - [x] å®ç°çº¿ç¨‹å®‰å…¨ï¼ˆä½¿ç”¨ `std::mutex` ä¿æŠ¤ï¼‰

- [x] **ç¼“å­˜æ¡ç›®ç»“æ„**
  - [x] å®ç° `put(const CacheKey& key, const ChatResponse& response, std::optional<std::chrono::seconds> ttl)` æ–¹æ³•
    - [x] åˆ›å»º `CacheEntry` å¯¹è±¡
    - [x] è®¾ç½®æ—¶é—´æˆ³å’Œ TTL
    - [x] å­˜å‚¨åˆ°ç¼“å­˜æ˜ å°„
    - [x] æ£€æŸ¥ç¼“å­˜å¤§å°é™åˆ¶ï¼ˆå¦‚æœå®ç°ï¼‰
    - [x] çº¿ç¨‹å®‰å…¨
  - [x] å®ç°ç¼“å­˜å¤§å°é™åˆ¶ï¼ˆå¯é€‰ï¼‰
    - [x] ä»é…ç½®è¯»å– `cache.max_entries`
    - [x] è¶…è¿‡é™åˆ¶æ—¶ä½¿ç”¨ LRU ç­–ç•¥æ·˜æ±°æ—§æ¡ç›®

- [x] **TTLç®¡ç†**
  - [x] ä» `ConfigManager` è¯»å– `cache.default_ttl_seconds` é…ç½®
  - [x] æ”¯æŒæŒ‰è¯·æ±‚è®¾ç½® TTLï¼ˆå¯é€‰ï¼‰
  - [x] å®ç° TTL æ£€æŸ¥
    - [x] `isExpired(const CacheEntry& entry)` - æ£€æŸ¥æ¡ç›®æ˜¯å¦è¿‡æœŸ
    - [x] æ¯”è¾ƒå½“å‰æ—¶é—´ä¸ `timestamp + ttl`

**éªŒæ”¶æ ‡å‡†**ï¼š
- å•æµ‹éªŒè¯ï¼šç¼“å­˜æ¡ç›®æ­£ç¡®å­˜å‚¨å’Œæ£€ç´¢ã€‚
- å•æµ‹éªŒè¯ï¼šTTL ç®¡ç†æ­£ç¡®ï¼ˆè¿‡æœŸæ¡ç›®ä¸å†è¿”å›ï¼‰ã€‚
- å•æµ‹éªŒè¯ï¼šçº¿ç¨‹å®‰å…¨ï¼ˆå¹¶å‘è¯»å†™æ— ç«æ€æ¡ä»¶ï¼‰ã€‚

#### 4.3.3.3 ç¼“å­˜æŸ¥è¯¢
- [x] **ç¼“å­˜æŸ¥æ‰¾å®ç°**
  - [x] å®ç° `get(const CacheKey& key)` æ–¹æ³•
    - [x] åœ¨ç¼“å­˜æ˜ å°„ä¸­æŸ¥æ‰¾é”®
    - [x] å¦‚æœæ‰¾åˆ°ï¼Œæ£€æŸ¥æ˜¯å¦è¿‡æœŸ
    - [x] å¦‚æœæœªè¿‡æœŸï¼Œæ›´æ–°è®¿é—®ç»Ÿè®¡ï¼ˆå¦‚æœå®ç° LRUï¼‰
    - [x] è¿”å› `std::optional<ChatResponse>`
    - [x] å¦‚æœæœªæ‰¾åˆ°æˆ–å·²è¿‡æœŸï¼Œè¿”å› `std::nullopt`
    - [x] çº¿ç¨‹å®‰å…¨
  - [x] å®ç°ç¼“å­˜å‘½ä¸­ç»Ÿè®¡
    - [x] è®°å½•ç¼“å­˜å‘½ä¸­æ¬¡æ•°
    - [x] è®°å½•ç¼“å­˜æœªå‘½ä¸­æ¬¡æ•°

- [x] **ç¼“å­˜æœ‰æ•ˆæ€§æ£€æŸ¥**
  - [x] å®ç° `isValid(const CacheEntry& entry)` æ–¹æ³•
    - [x] æ£€æŸ¥æ˜¯å¦è¿‡æœŸ
    - [x] æ£€æŸ¥å“åº”æ˜¯å¦æœ‰æ•ˆï¼ˆå¯é€‰ï¼‰
  - [x] åœ¨æŸ¥è¯¢æ—¶è‡ªåŠ¨æ¸…ç†è¿‡æœŸæ¡ç›®ï¼ˆå¯é€‰ï¼‰
    - [x] å‘ç°è¿‡æœŸæ¡ç›®æ—¶åˆ é™¤
    - [x] æˆ–å®šæœŸæ¸…ç†ï¼ˆè§ 4.3.3.4ï¼‰

**éªŒæ”¶æ ‡å‡†**ï¼š
- å•æµ‹éªŒè¯ï¼šç¼“å­˜æŸ¥è¯¢æ­£ç¡®ï¼ˆå‘½ä¸­/æœªå‘½ä¸­/è¿‡æœŸéƒ½èƒ½æ­£ç¡®å¤„ç†ï¼‰ã€‚
- å•æµ‹éªŒè¯ï¼šç¼“å­˜å‘½ä¸­ç»Ÿè®¡å‡†ç¡®ã€‚

#### 4.3.3.4 ç¼“å­˜è¿‡æœŸæ¸…ç†
- [x] **è¿‡æœŸæ¡ç›®æ¸…ç†**
  - [x] å®ç° `evictExpired()` æ–¹æ³•
    - [x] éå†æ‰€æœ‰ç¼“å­˜æ¡ç›®
    - [x] æ£€æŸ¥æ¯ä¸ªæ¡ç›®æ˜¯å¦è¿‡æœŸ
    - [x] åˆ é™¤è¿‡æœŸæ¡ç›®
    - [x] è¿”å›æ¸…ç†çš„æ¡ç›®æ•°
    - [x] çº¿ç¨‹å®‰å…¨
  - [x] å®ç°å®šæœŸæ¸…ç†æœºåˆ¶
    - [x] å®šä¹‰æ¸…ç†çº¿ç¨‹æˆ–å®šæ—¶å™¨
    - [x] å®šæœŸè°ƒç”¨ `evictExpired()`
    - [x] ä»é…ç½®è¯»å–æ¸…ç†é—´éš”ï¼ˆ`cache.cleanup_interval_seconds`ï¼‰

- [x] **LRUæ·˜æ±°ç­–ç•¥ï¼ˆå¯é€‰ï¼‰**
  - [x] å®ç° LRUï¼ˆLeast Recently Usedï¼‰æ·˜æ±°
    - [x] ç»´æŠ¤è®¿é—®æ—¶é—´æˆ³
    - [x] ç¼“å­˜æ»¡æ—¶æ·˜æ±°æœ€ä¹…æœªä½¿ç”¨çš„æ¡ç›®
  - [x] å®ç° `evictLRU(size_t count)` æ–¹æ³•
    - [x] æŒ‰ `lastAccessTime` æ’åº
    - [x] åˆ é™¤æœ€ä¹…æœªä½¿ç”¨çš„ N ä¸ªæ¡ç›®

- [x] **ç¼“å­˜å¤§å°ç®¡ç†**
  - [x] å®ç°ç¼“å­˜å¤§å°é™åˆ¶
    - [x] ä»é…ç½®è¯»å– `cache.max_entries`
    - [x] è®¡ç®—å½“å‰ç¼“å­˜å¤§å°ï¼ˆå†…å­˜å ç”¨ï¼Œä¼°ç®—ï¼‰
    - [x] è¶…è¿‡é™åˆ¶æ—¶è§¦å‘æ¸…ç†æˆ–æ·˜æ±°
  - [x] å®ç° `getCacheSize()` æ–¹æ³•
    - [x] è¿”å›å½“å‰ç¼“å­˜æ¡ç›®æ•°
    - [x] è¿”å›å½“å‰ç¼“å­˜å¤§å°ï¼ˆå­—èŠ‚ï¼Œé€šè¿‡ `getStatistics()` è·å–ï¼‰

**éªŒæ”¶æ ‡å‡†**ï¼š
- å•æµ‹éªŒè¯ï¼šè¿‡æœŸæ¡ç›®è¢«æ­£ç¡®æ¸…ç†ã€‚
- å•æµ‹éªŒè¯ï¼šå®šæœŸæ¸…ç†æœºåˆ¶å·¥ä½œæ­£å¸¸ã€‚
- å•æµ‹éªŒè¯ï¼šLRU æ·˜æ±°ç­–ç•¥æ­£ç¡®ï¼ˆå¦‚æœå®ç°ï¼‰ã€‚

#### 4.3.3.5 ç¼“å­˜ç»Ÿè®¡ï¼ˆå‘½ä¸­ç‡ç­‰ï¼‰
- [x] **ç»Ÿè®¡æ•°æ®ç»“æ„**
  - [x] å®šä¹‰ `CacheStatistics` ç»“æ„ä½“
    - [x] `totalHits`ï¼ˆæ€»å‘½ä¸­æ•°ï¼‰
    - [x] `totalMisses`ï¼ˆæ€»æœªå‘½ä¸­æ•°ï¼‰
    - [x] `hitRate`ï¼ˆå‘½ä¸­ç‡ï¼Œè®¡ç®—å¾—å‡ºï¼š`hits / (hits + misses)`ï¼‰
    - [x] `totalEntries`ï¼ˆå½“å‰ç¼“å­˜æ¡ç›®æ•°ï¼‰
    - [x] `totalSize`ï¼ˆå½“å‰ç¼“å­˜å¤§å°ï¼Œå­—èŠ‚ï¼‰
    - [x] `evictedEntries`ï¼ˆè¢«æ·˜æ±°çš„æ¡ç›®æ•°ï¼‰
  - [x] ä½¿ç”¨çº¿ç¨‹å®‰å…¨çš„æ•°æ®ç»“æ„

- [x] **ç»Ÿè®¡æ›´æ–°**
  - [x] åœ¨ç¼“å­˜æŸ¥è¯¢æ—¶æ›´æ–°ç»Ÿè®¡
    - [x] å‘½ä¸­æ—¶ `totalHits++`
    - [x] æœªå‘½ä¸­æ—¶ `totalMisses++`
  - [x] åœ¨ç¼“å­˜å­˜å‚¨æ—¶æ›´æ–°ç»Ÿè®¡
    - [x] `totalEntries++`
    - [x] `totalSize += entrySize`
  - [x] åœ¨ç¼“å­˜æ¸…ç†æ—¶æ›´æ–°ç»Ÿè®¡
    - [x] `evictedEntries += evictedCount`
    - [x] `totalEntries -= evictedCount`

- [x] **ç»Ÿè®¡æŸ¥è¯¢æ¥å£**
  - [x] å®ç° `getStatistics()` æ–¹æ³•
    - [x] è¿”å›å®Œæ•´çš„ `CacheStatistics` ç»“æ„
    - [x] è®¡ç®—å‘½ä¸­ç‡ï¼ˆ`totalHits / (totalHits + totalMisses)`ï¼‰
  - [x] å®ç° `getHitRate()` æ–¹æ³•
    - [x] è¿”å›å½“å‰å‘½ä¸­ç‡ï¼ˆ0-1ï¼‰

- [x] **ç¼“å­˜æ¸…ç©ºæ¥å£**
  - [x] å®ç° `clear()` æ–¹æ³•
    - [x] æ¸…ç©ºæ‰€æœ‰ç¼“å­˜æ¡ç›®
    - [x] é‡ç½®ç»Ÿè®¡ä¿¡æ¯
    - [x] çº¿ç¨‹å®‰å…¨

**éªŒæ”¶æ ‡å‡†**ï¼š
- å•æµ‹éªŒè¯ï¼šç»Ÿè®¡ä¿¡æ¯æ­£ç¡®æ›´æ–°ã€‚
- å•æµ‹éªŒè¯ï¼šå‘½ä¸­ç‡è®¡ç®—æ­£ç¡®ã€‚
- å•æµ‹éªŒè¯ï¼šç¼“å­˜æ¸…ç©ºåŠŸèƒ½æ­£å¸¸ã€‚

---

## 4.4 å•å…ƒæµ‹è¯•ä¸ç¤ºä¾‹

### 4.4.1 å•å…ƒæµ‹è¯•
- [x] **RequestManageræµ‹è¯•**
  - [x] è¯·æ±‚é˜Ÿåˆ—æµ‹è¯•ï¼ˆå…¥é˜Ÿ/å‡ºé˜Ÿã€ä¼˜å…ˆçº§æ’åºã€é˜Ÿåˆ—å¤§å°é™åˆ¶ï¼‰
  - [x] å¹¶å‘æ§åˆ¶æµ‹è¯•ï¼ˆå¹¶å‘é™åˆ¶ã€å¹¶å‘è®¡æ•°ã€å¤šæ¨¡å‹ç‹¬ç«‹é™åˆ¶ï¼‰
  - [x] è¯·æ±‚è°ƒåº¦æµ‹è¯•ï¼ˆé˜Ÿåˆ—å¤„ç†å¾ªç¯ã€è¯·æ±‚åˆ†å‘ã€è¶…æ—¶ç®¡ç†ï¼‰
  - [x] è¯·æ±‚å–æ¶ˆæµ‹è¯•ï¼ˆé˜Ÿåˆ—ä¸­å–æ¶ˆã€å¤„ç†ä¸­å–æ¶ˆï¼‰
  - [x] è¯·æ±‚ç»Ÿè®¡æµ‹è¯•ï¼ˆç»Ÿè®¡æ›´æ–°ã€å¹³å‡å“åº”æ—¶é—´è®¡ç®—ï¼‰

- [x] **ResponseHandleræµ‹è¯•**
  - [x] æµå¼å“åº”å¤„ç†æµ‹è¯•ï¼ˆSSEè§£æã€å¢é‡æå–ã€å›è°ƒç®¡ç†ï¼‰
    - [x] ç®€å•æ–‡æœ¬æµæµ‹è¯•
    - [x] å®ŒæˆåŸå› æµ‹è¯•
    - [x] å·¥å…·è°ƒç”¨å¢é‡æµ‹è¯•
    - [x] é”™è¯¯å¤„ç†æµ‹è¯•
  - [x] å“åº”éªŒè¯æµ‹è¯•ï¼ˆJSONæ ¼å¼éªŒè¯ã€å¿…éœ€å­—æ®µæ£€æŸ¥ã€å†…å®¹éªŒè¯ï¼‰
    - [x] æœ‰æ•ˆJSONéªŒè¯
    - [x] æ— æ•ˆJSONéªŒè¯ï¼ˆç¼ºå¤±å­—æ®µã€ç©ºæ•°ç»„ç­‰ï¼‰
    - [x] æ— æ•ˆå®ŒæˆåŸå› éªŒè¯
    - [x] ç©ºå†…å®¹éªŒè¯
    - [x] å·¥å…·è°ƒç”¨éªŒè¯
  - [x] ç¼“å­˜é›†æˆæµ‹è¯•ï¼ˆç¼“å­˜æŸ¥è¯¢ã€ç¼“å­˜å­˜å‚¨ã€ç¼“å­˜ç­–ç•¥ï¼‰
    - [x] ç¼“å­˜å‘½ä¸­/æœªå‘½ä¸­æµ‹è¯•
    - [x] å­˜å‚¨å’Œæ£€ç´¢æµ‹è¯•
    - [x] æµå¼è¯·æ±‚ä¸ç¼“å­˜æµ‹è¯•
    - [x] é«˜æ¸©åº¦è¯·æ±‚ä¸ç¼“å­˜æµ‹è¯•
    - [x] ä½æ¸©åº¦è¯·æ±‚ç¼“å­˜æµ‹è¯•
    - [x] ç¦ç”¨ç¼“å­˜æµ‹è¯•
  - [x] å“åº”ç»Ÿè®¡æµ‹è¯•ï¼ˆç»Ÿè®¡æ›´æ–°ã€ç¼“å­˜å‘½ä¸­ç‡ï¼‰
    - [x] åˆå§‹çŠ¶æ€æµ‹è¯•
    - [x] ç¼“å­˜å‘½ä¸­ç‡æµ‹è¯•
    - [x] å¹³å‡å“åº”å¤§å°æµ‹è¯•

- [x] **CacheManageræµ‹è¯•**
  - [x] ç¼“å­˜é”®ç”Ÿæˆæµ‹è¯•ï¼ˆç›¸åŒè¯·æ±‚ç›¸åŒé”®ã€ä¸åŒè¯·æ±‚ä¸åŒé”®ï¼‰
  - [x] ç¼“å­˜å­˜å‚¨æµ‹è¯•ï¼ˆå­˜å‚¨/æ£€ç´¢ã€TTLç®¡ç†ã€çº¿ç¨‹å®‰å…¨ï¼‰
  - [x] ç¼“å­˜æŸ¥è¯¢æµ‹è¯•ï¼ˆå‘½ä¸­/æœªå‘½ä¸­/è¿‡æœŸå¤„ç†ï¼‰
  - [x] ç¼“å­˜æ¸…ç†æµ‹è¯•ï¼ˆè¿‡æœŸæ¸…ç†ã€LRUæ·˜æ±°ã€å®šæœŸæ¸…ç†ï¼‰
  - [x] ç¼“å­˜ç»Ÿè®¡æµ‹è¯•ï¼ˆå‘½ä¸­ç‡è®¡ç®—ã€ç»Ÿè®¡æ›´æ–°ï¼‰

### 4.4.2 é›†æˆæµ‹è¯•
- [x] **RequestManager + APIClient é›†æˆæµ‹è¯•**
  - [x] ç«¯åˆ°ç«¯è¯·æ±‚å¤„ç†æµç¨‹
  - [x] å¹¶å‘è¯·æ±‚å¤„ç†
  - [x] è¶…æ—¶å’Œå–æ¶ˆå¤„ç†

- [x] **ResponseHandler + CacheManager é›†æˆæµ‹è¯•**
  - [x] ç¼“å­˜å‘½ä¸­æ—¶çš„å“åº”å¤„ç†
  - [x] ç¼“å­˜æœªå‘½ä¸­æ—¶çš„APIè°ƒç”¨å’Œå­˜å‚¨
  - [x] æµå¼å“åº”çš„ç¼“å­˜ç­–ç•¥

- [x] **å®Œæ•´æµç¨‹é›†æˆæµ‹è¯•**
  - [x] RequestManager -> APIClient -> ResponseHandler -> CacheManager
  - [x] å¹¶å‘åœºæ™¯ä¸‹çš„å®Œæ•´æµç¨‹
  - [x] é”™è¯¯å¤„ç†å’Œé‡è¯•é›†æˆ

---

## å¼€å‘é¡ºåºå»ºè®®

### ç¬¬ä¸€é˜¶æ®µï¼šç¼“å­˜ç®¡ç†å™¨ï¼ˆ4.3ï¼‰
1. å…ˆå®Œæˆ `CacheManager`ï¼Œå› ä¸ºå®ƒç›¸å¯¹ç‹¬ç«‹ï¼Œä¸”è¢« `ResponseHandler` ä¾èµ–ã€‚
2. å®ç°ç¼“å­˜é”®ç”Ÿæˆã€å­˜å‚¨ã€æŸ¥è¯¢å’Œç»Ÿè®¡ã€‚

### ç¬¬äºŒé˜¶æ®µï¼šå“åº”å¤„ç†å™¨ï¼ˆ4.2ï¼‰
1. å®Œæˆ `ResponseHandler`ï¼Œé›†æˆ `CacheManager`ã€‚
2. å®ç°æµå¼å“åº”å¤„ç†ã€å“åº”éªŒè¯å’Œç¼“å­˜é›†æˆã€‚

### ç¬¬ä¸‰é˜¶æ®µï¼šè¯·æ±‚ç®¡ç†å™¨ï¼ˆ4.1ï¼‰
1. å®Œæˆ `RequestManager`ï¼Œè¿™æ˜¯æœ€å¤æ‚çš„æ¨¡å—ã€‚
2. å®ç°è¯·æ±‚é˜Ÿåˆ—ã€å¹¶å‘æ§åˆ¶å’Œè¯·æ±‚è°ƒåº¦ã€‚
3. é›†æˆ `APIClient` å’Œ `ResponseHandler`ã€‚

### ç¬¬å››é˜¶æ®µï¼šé›†æˆå’Œæµ‹è¯•
1. å®Œæˆæ‰€æœ‰æ¨¡å—çš„é›†æˆæµ‹è¯•ã€‚
2. æ€§èƒ½æµ‹è¯•å’Œä¼˜åŒ–ã€‚

---

## è¿›åº¦è¿½è¸ª

### 4.1 è¯·æ±‚ç®¡ç†å™¨ï¼ˆRequestManagerï¼‰
- [x] è¯·æ±‚é˜Ÿåˆ—å®ç°
- [x] å¹¶å‘æ§åˆ¶å™¨å®ç°
- [x] è¯·æ±‚è°ƒåº¦å™¨å®ç°
- [x] è¯·æ±‚å–æ¶ˆæœºåˆ¶
- [x] è¯·æ±‚ç»Ÿè®¡
- [x] å•å…ƒæµ‹è¯•

**è¿›åº¦**: 5/6 ä¸»è¦æ¨¡å—å®Œæˆ

### 4.2 å“åº”å¤„ç†å™¨ï¼ˆResponseHandlerï¼‰
- [x] æµå¼å“åº”å¤„ç†
- [x] å“åº”éªŒè¯
- [x] å“åº”ç¼“å­˜é›†æˆ
- [x] å“åº”ç»Ÿè®¡
- [x] å•å…ƒæµ‹è¯•

**è¿›åº¦**: 5/5 ä¸»è¦æ¨¡å—å®Œæˆ

### 4.3 ç¼“å­˜ç®¡ç†å™¨ï¼ˆCacheManagerï¼‰
- [x] ç¼“å­˜é”®ç”Ÿæˆ
- [x] ç¼“å­˜å­˜å‚¨å®ç°
- [x] ç¼“å­˜æŸ¥è¯¢
- [x] ç¼“å­˜è¿‡æœŸæ¸…ç†
- [x] ç¼“å­˜ç»Ÿè®¡
- [x] å•å…ƒæµ‹è¯•

**è¿›åº¦**: 6/6 ä¸»è¦æ¨¡å—å®Œæˆ

**æ€»è®¡**: 17/17 ä¸»è¦æ¨¡å—å®Œæˆï¼ˆåŒ…å«é›†æˆæµ‹è¯•ï¼‰

---

## ä¾èµ–å…³ç³»

```
Phase1 (åŸºç¡€è®¾æ–½å±‚)
  â†“
Phase2 (APIå®¢æˆ·ç«¯å±‚)
  â†“
Phase3 (æ ¸å¿ƒç®¡ç†å±‚)
  â†“
Phase4 (æœåŠ¡ç®¡ç†å±‚)
  â”œâ”€â”€ 4.3 CacheManager (ç›¸å¯¹ç‹¬ç«‹)
  â”œâ”€â”€ 4.2 ResponseHandler (ä¾èµ– 4.3 CacheManager)
  â””â”€â”€ 4.1 RequestManager (ä¾èµ– 4.2 ResponseHandler + Phase2 APIClient)
```

---

## æ³¨æ„äº‹é¡¹

1. **çº¿ç¨‹å®‰å…¨**ï¼šæ‰€æœ‰æ¨¡å—éƒ½éœ€è¦è€ƒè™‘çº¿ç¨‹å®‰å…¨ï¼Œä½¿ç”¨ `std::mutex` æˆ– `std::atomic` ä¿æŠ¤å…±äº«æ•°æ®ã€‚
2. **æ€§èƒ½ä¼˜åŒ–**ï¼šè¯·æ±‚é˜Ÿåˆ—å’Œç¼“å­˜éƒ½éœ€è¦è€ƒè™‘æ€§èƒ½ï¼Œé¿å…æˆä¸ºç“¶é¢ˆã€‚
3. **å†…å­˜ç®¡ç†**ï¼šç¼“å­˜ç®¡ç†å™¨éœ€è¦æ³¨æ„å†…å­˜ä½¿ç”¨ï¼Œå®ç°åˆç†çš„æ·˜æ±°ç­–ç•¥ã€‚
4. **é”™è¯¯å¤„ç†**ï¼šæ‰€æœ‰æ¨¡å—éƒ½éœ€è¦å®Œå–„çš„é”™è¯¯å¤„ç†ï¼Œç¡®ä¿ç³»ç»Ÿç¨³å®šæ€§ã€‚
5. **é…ç½®åŒ–**ï¼šæ‰€æœ‰å…³é”®å‚æ•°éƒ½åº”è¯¥å¯é…ç½®ï¼Œé€šè¿‡ `ConfigManager` è¯»å–ã€‚
6. **ç»Ÿè®¡å’Œç›‘æ§**ï¼šå®ç°å®Œå–„çš„ç»Ÿè®¡åŠŸèƒ½ï¼Œä¾¿äºç›‘æ§å’Œä¼˜åŒ–ã€‚

---

*æœ€åæ›´æ–°: 2025å¹´12æœˆ29æ—¥*

## æ›´æ–°æ—¥å¿—

### 2025å¹´12æœˆ29æ—¥ï¼ˆæ›´æ–°2ï¼‰
- âœ… å®Œæˆ 4.2 å“åº”å¤„ç†å™¨ï¼ˆResponseHandlerï¼‰çš„å®ç°
  - âœ… å®ç°æµå¼å“åº”å¤„ç†ï¼ˆSSEæ•°æ®æµè§£æã€å¢é‡å†…å®¹æå–ã€æµå¼å›è°ƒç®¡ç†ï¼‰
    - âœ… å¤ç”¨ APIClient ä¸­çš„ SseDecoder å’Œ ChatStreamAggregator é€»è¾‘
    - âœ… å®ç° handleStreamResponse() æ–¹æ³•ï¼Œæ”¯æŒæ–‡æœ¬å’Œå·¥å…·è°ƒç”¨çš„æµå¼å¤„ç†
  - âœ… å®ç°å“åº”éªŒè¯ï¼ˆJSONæ ¼å¼éªŒè¯ã€å¿…éœ€å­—æ®µæ£€æŸ¥ã€å“åº”å†…å®¹éªŒè¯ï¼‰
    - âœ… å®ç° validateResponse() æ–¹æ³•ï¼ˆæ”¯æŒ JSON å’Œ ChatResponse ä¸¤ç§è¾“å…¥ï¼‰
    - âœ… å®ç°å®Œæ•´çš„éªŒè¯æµç¨‹ï¼šç»“æ„éªŒè¯ã€å­—æ®µæ£€æŸ¥ã€å†…å®¹éªŒè¯
  - âœ… å®ç°å“åº”ç¼“å­˜é›†æˆï¼ˆç¼“å­˜æŸ¥è¯¢ã€ç¼“å­˜å­˜å‚¨ã€ç¼“å­˜ç­–ç•¥ï¼‰
    - âœ… å®ç° checkCache() å’Œ storeCache() æ–¹æ³•
    - âœ… å®ç° shouldCache() ç¼“å­˜ç­–ç•¥åˆ¤æ–­ï¼ˆæ¸©åº¦ã€æµå¼ã€å·¥å…·è°ƒç”¨ï¼‰
    - âœ… ä» ConfigManager è¯»å–ç¼“å­˜é…ç½®
  - âœ… å®ç°å“åº”ç»Ÿè®¡ï¼ˆç»Ÿè®¡æ•°æ®ç»“æ„ã€ç»Ÿè®¡æ›´æ–°ã€ç»Ÿè®¡æŸ¥è¯¢æ¥å£ï¼‰
    - âœ… å®ç° ResponseStatistics ç»“æ„ä½“ï¼ˆåŒ…å«æ‰€æœ‰ç»Ÿè®¡æŒ‡æ ‡ï¼‰
    - âœ… å®ç°ç»Ÿè®¡æ›´æ–°é€»è¾‘ï¼ˆåœ¨ checkCache() ä¸­æ›´æ–°ï¼‰
    - âœ… å®ç° getStatistics() å’Œ getCacheHitRate() æŸ¥è¯¢æ¥å£
  - âœ… å®Œæˆå•å…ƒæµ‹è¯•ï¼ˆ22ä¸ªæµ‹è¯•ç”¨ä¾‹ï¼Œè¦†ç›–æ‰€æœ‰åŠŸèƒ½ç‚¹ï¼‰
    - âœ… æµå¼å“åº”å¤„ç†æµ‹è¯•ï¼ˆ4ä¸ªæµ‹è¯•ç”¨ä¾‹ï¼‰
    - âœ… å“åº”éªŒè¯æµ‹è¯•ï¼ˆ6ä¸ªæµ‹è¯•ç”¨ä¾‹ï¼‰
    - âœ… ç¼“å­˜é›†æˆæµ‹è¯•ï¼ˆ6ä¸ªæµ‹è¯•ç”¨ä¾‹ï¼‰
    - âœ… å“åº”ç»Ÿè®¡æµ‹è¯•ï¼ˆ3ä¸ªæµ‹è¯•ç”¨ä¾‹ï¼‰
    - âœ… JSONæ ¼å¼éªŒè¯æµ‹è¯•ï¼ˆ3ä¸ªæµ‹è¯•ç”¨ä¾‹ï¼‰
  - ğŸ“ æ–‡ä»¶å·²åˆ›å»ºï¼š
    - `include/naw/desktop_pet/service/ResponseHandler.h`
    - `src/naw/desktop_pet/service/ResponseHandler.cpp`
    - `src/naw/desktop_pet/service/tests/ResponseHandlerTest.cpp`
  - ğŸ“ å·²æ›´æ–°æ„å»ºç³»ç»Ÿï¼š`src/naw/desktop_pet/service/CMakeLists.txt`

### 2025å¹´12æœˆ29æ—¥
- âœ… å®Œæˆ 4.1 è¯·æ±‚ç®¡ç†å™¨ï¼ˆRequestManagerï¼‰çš„å®ç°
  - âœ… å®ç°è¯·æ±‚é˜Ÿåˆ—ï¼ˆä¼˜å…ˆçº§é˜Ÿåˆ—ã€å…¥é˜Ÿ/å‡ºé˜Ÿã€é˜Ÿåˆ—å¤§å°é™åˆ¶ï¼‰
  - âœ… å®ç°å¹¶å‘æ§åˆ¶ï¼ˆæŒ‰æ¨¡å‹é™åˆ¶å¹¶å‘æ•°ã€å¹¶å‘æ§½ä½ç®¡ç†ã€å¹¶å‘ç»Ÿè®¡æŸ¥è¯¢ï¼‰
  - âœ… å®ç°è¯·æ±‚è°ƒåº¦ï¼ˆå·¥ä½œçº¿ç¨‹ã€é˜Ÿåˆ—å¤„ç†å¾ªç¯ã€è¯·æ±‚åˆ†å‘ã€è¶…æ—¶ç®¡ç†ï¼‰
  - âœ… å®ç°è¯·æ±‚å–æ¶ˆæœºåˆ¶ï¼ˆå–æ¶ˆä»¤ç‰Œã€å–æ¶ˆæ¥å£ã€å–æ¶ˆçŠ¶æ€è·Ÿè¸ªï¼‰
  - âœ… å®ç°è¯·æ±‚ç»Ÿè®¡ï¼ˆç»Ÿè®¡æ•°æ®ç»“æ„ã€ç»Ÿè®¡æ›´æ–°ã€ç»Ÿè®¡æŸ¥è¯¢æ¥å£ï¼‰
  - ğŸ“ æ–‡ä»¶å·²åˆ›å»ºï¼š
    - `include/naw/desktop_pet/service/RequestManager.h`
    - `src/naw/desktop_pet/service/RequestManager.cpp`
  - ğŸ“ å·²æ›´æ–°æ„å»ºç³»ç»Ÿï¼š`src/naw/desktop_pet/service/CMakeLists.txt`

- âœ… å®Œæˆ 4.3 ç¼“å­˜ç®¡ç†å™¨ï¼ˆCacheManagerï¼‰çš„å®ç°
  - âœ… å®ç°ç¼“å­˜é”®ç”Ÿæˆï¼ˆåŸºäºè¯·æ±‚å†…å®¹çš„å“ˆå¸Œã€å‚æ•°åŒ…å«ã€é”®æ¯”è¾ƒï¼‰
  - âœ… å®ç°ç¼“å­˜å­˜å‚¨ï¼ˆå†…å­˜ç¼“å­˜ã€ç¼“å­˜æ¡ç›®ç»“æ„ã€TTLç®¡ç†ã€å¤§å°é™åˆ¶ã€LRUæ·˜æ±°ï¼‰
  - âœ… å®ç°ç¼“å­˜æŸ¥è¯¢ï¼ˆç¼“å­˜æŸ¥æ‰¾ã€å‘½ä¸­ç»Ÿè®¡ã€æœ‰æ•ˆæ€§æ£€æŸ¥ï¼‰
  - âœ… å®ç°ç¼“å­˜è¿‡æœŸæ¸…ç†ï¼ˆè¿‡æœŸæ¡ç›®æ¸…ç†ã€å®šæœŸæ¸…ç†æœºåˆ¶ã€LRUæ·˜æ±°ç­–ç•¥ï¼‰
  - âœ… å®ç°ç¼“å­˜ç»Ÿè®¡ï¼ˆç»Ÿè®¡æ•°æ®ç»“æ„ã€ç»Ÿè®¡æ›´æ–°ã€ç»Ÿè®¡æŸ¥è¯¢æ¥å£ã€ç¼“å­˜æ¸…ç©ºï¼‰
  - âœ… å®Œæˆå•å…ƒæµ‹è¯•ï¼ˆ17ä¸ªæµ‹è¯•ç”¨ä¾‹ï¼Œè¦†ç›–æ‰€æœ‰åŠŸèƒ½ç‚¹ï¼‰
  - ğŸ“ æ–‡ä»¶å·²åˆ›å»ºï¼š
    - `include/naw/desktop_pet/service/CacheManager.h`
    - `src/naw/desktop_pet/service/CacheManager.cpp`
    - `src/naw/desktop_pet/service/tests/CacheManagerTest.cpp`
  - ğŸ“ å·²æ›´æ–°æ„å»ºç³»ç»Ÿï¼š`src/naw/desktop_pet/service/CMakeLists.txt`

### 2025å¹´12æœˆ30æ—¥
- âœ… å®Œæˆ 4.4.2 é›†æˆæµ‹è¯•çš„å®ç°
  - âœ… å®ç° RequestManager + APIClient é›†æˆæµ‹è¯•
    - âœ… ç«¯åˆ°ç«¯è¯·æ±‚å¤„ç†æµç¨‹æµ‹è¯•
    - âœ… å¹¶å‘è¯·æ±‚å¤„ç†æµ‹è¯•
    - âœ… è¶…æ—¶å’Œå–æ¶ˆå¤„ç†æµ‹è¯•
  - âœ… å®ç° ResponseHandler + CacheManager é›†æˆæµ‹è¯•
    - âœ… ç¼“å­˜å‘½ä¸­æ—¶çš„å“åº”å¤„ç†æµ‹è¯•
    - âœ… ç¼“å­˜æœªå‘½ä¸­æ—¶çš„APIè°ƒç”¨å’Œå­˜å‚¨æµ‹è¯•
    - âœ… æµå¼å“åº”çš„ç¼“å­˜ç­–ç•¥æµ‹è¯•
    - âœ… é«˜æ¸©åº¦è¯·æ±‚ä¸ç¼“å­˜æµ‹è¯•
  - âœ… å®ç°å®Œæ•´æµç¨‹é›†æˆæµ‹è¯•
    - âœ… RequestManager -> APIClient -> ResponseHandler -> CacheManager å®Œæ•´æµç¨‹æµ‹è¯•
    - âœ… å¹¶å‘åœºæ™¯ä¸‹çš„å®Œæ•´æµç¨‹æµ‹è¯•
    - âœ… é”™è¯¯å¤„ç†å’Œé‡è¯•é›†æˆæµ‹è¯•
  - ğŸ“ æ–‡ä»¶å·²åˆ›å»ºï¼š
    - `src/naw/desktop_pet/service/tests/Phase4IntegrationTest.cpp`
  - ğŸ“ å·²æ›´æ–°æ„å»ºç³»ç»Ÿï¼š`src/naw/desktop_pet/service/CMakeLists.txt`
  - ğŸ“ é›†æˆæµ‹è¯•åŒ…å« 9 ä¸ªæµ‹è¯•ç”¨ä¾‹ï¼Œè¦†ç›–æ‰€æœ‰é›†æˆåœºæ™¯

